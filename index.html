<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>é’¢ç­‹é¢†ç”¨åº“å­˜ç®¡ç†ç³»ç»Ÿ (ç¦»çº¿ç‰ˆ)</title>
    
    <!-- 
      === ç¦»çº¿ç‰ˆé…ç½®è¯´æ˜ ===
      æœ¬ç‰ˆæœ¬ä¾èµ–æœ¬åœ°åº“æ–‡ä»¶ã€‚è¯·ç¡®ä¿å½“å‰ç›®å½•ä¸‹æœ‰ "lib" æ–‡ä»¶å¤¹ï¼Œ
      å¹¶ä¸”åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š
      1. lib/tailwindcss.js
      2. lib/react.production.min.js
      3. lib/react-dom.production.min.js
      4. lib/babel.min.js
    -->

    <!-- 1. åŠ è½½æœ¬åœ° Tailwind CSS -->
    <script src="lib/tailwindcss.js"></script>
    <script>
      // é…ç½® Tailwind (ç¦»çº¿æ¨¡å¼å»ºè®®æ˜¾å¼é…ç½®)
      if (typeof tailwind !== 'undefined') {
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                primary: '#2563eb',
              },
              animation: {
                'fade-in': 'fadeIn 0.5s ease-out',
                'fade-in-up': 'fadeInUp 0.3s ease-out',
              },
              keyframes: {
                fadeIn: {
                  '0%': { opacity: '0' },
                  '100%': { opacity: '1' },
                },
                fadeInUp: {
                  '0%': { opacity: '0', transform: 'translateY(10px)' },
                  '100%': { opacity: '1', transform: 'translateY(0)' },
                }
              }
            }
          }
        }
      }
    </script>
    
    <!-- 2. åŠ è½½æœ¬åœ° React å’Œ ReactDOM -->
    <script src="lib/react.production.min.js"></script>
    <script src="lib/react-dom.production.min.js"></script>
    
    <!-- 3. åŠ è½½æœ¬åœ° Babel -->
    <script src="lib/babel.min.js"></script>

    <style>
      body {
        background-color: #f3f4f6;
        color: #1f2937;
      }
      #root {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      /* åŠ è½½å¤±è´¥æ—¶çš„æç¤º */
      #loading-error {
        display: none;
        padding: 40px;
        color: #ef4444;
        text-align: center;
        margin-top: 50px;
        background: white;
        border-radius: 8px;
        margin: 20px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      /* éšè—æ•°å­—è¾“å…¥æ¡†çš„ç®­å¤´ */
      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      /* ç®€å•çš„åŠ è½½åŠ¨ç”» */
      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #2563eb;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
</head>
<body>
    <div id="loading-error">
      <div class="loading-spinner"></div>
      <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">ç³»ç»ŸåŠ è½½ä¸­...</h3>
      <div id="error-text" style="font-size: 14px; color: #666;">
        å¦‚æœé•¿æ—¶é—´åœç•™åœ¨äº›é¡µé¢ï¼Œè¯´æ˜ç¼ºå°‘æœ¬åœ°èµ„æºåº“ã€‚<br/><br/>
        è¯·ç¡®ä¿ <b>lib</b> æ–‡ä»¶å¤¹å·²åˆ›å»ºï¼Œå¹¶åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š<br/>
        tailwindcss.js, react.production.min.js,<br/>
        react-dom.production.min.js, babel.min.js
      </div>
    </div>
    <div id="root"></div>

    <script>
      // æ£€æŸ¥ä¾èµ–æ˜¯å¦åŠ è½½æˆåŠŸ
      window.onload = function() {
        setTimeout(function() {
          if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof Babel === 'undefined' || typeof tailwind === 'undefined') {
            const errorDiv = document.getElementById('loading-error');
            const errorText = document.getElementById('error-text');
            errorDiv.style.display = 'block';
            errorText.innerHTML = `
              <span style="color:red; font-weight:bold;">âŒ åŠ è½½å¤±è´¥ï¼šç¼ºå°‘æœ¬åœ°åº“æ–‡ä»¶</span><br/><br/>
              æœªæ£€æµ‹åˆ° React æˆ– Tailwind ç¯å¢ƒã€‚<br/>
              è¯·æ£€æŸ¥ <b>lib/</b> æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶æ˜¯å¦å®Œæ•´ã€‚
            `;
          } else {
             // æˆåŠŸåŠ è½½ï¼ŒReact ä¼šæ¥ç®¡ rootï¼Œå› æ­¤éšè— loading
             document.getElementById('loading-error').style.display = 'none';
          }
        }, 500); 
      }
    </script>

    <!-- 4. åµŒå…¥å¼åº”ç”¨ä»£ç  -->
    <script type="text/babel" data-presets="react">
      const { useState, useEffect, useMemo, useRef } = React;
      const { createRoot } = ReactDOM;

      // --- Icons (SVG) ---
      const IconDashboard = () => <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>;
      const IconPlus = () => <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
      const IconList = () => <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>;
      const IconSettings = () => <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
      const IconDownload = () => <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>;
      const IconTrash = () => <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
      const IconEdit = () => <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>;
      const IconUpload = () => <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m-4-4v12" /></svg>;
      const IconFileExcel = () => <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
      const IconDesktop = () => <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>;
      const IconSwitch = () => <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>;
      const IconChart = () => <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>;
      const IconSearch = () => <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>;
      const IconX = () => <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>;

      // --- Helper Functions ---
      const fixFloat = (n) => {
        return Math.round((n + Number.EPSILON) * 1000) / 1000;
      };

      const downloadCSV = (content, filename) => {
        const blob = new Blob(["\ufeff" + content], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.click();
      };

      const calculateStock = (transactions, spec) => {
        return transactions.reduce((acc, t) => {
          if (t.spec !== spec) return acc;
          const w = fixFloat(t.weight);
          if (t.subType === 'å†…éƒ¨è°ƒæ‹¨-å‡º' || t.subType === 'å†…éƒ¨è°ƒæ‹¨-å…¥' || t.subType === 'ç›´æ”¶ç›´å‘') return acc;
          return fixFloat(acc + (t.type === 'IN' ? w : -w));
        }, 0);
      };

      const calculateTeamStock = (transactions, team, spec) => {
        return transactions.reduce((acc, t) => {
          if (t.party !== team || t.spec !== spec) return acc;
          const w = fixFloat(t.weight);
          
          if (t.type === 'OUT') {
              return fixFloat(acc + w); 
          } else if (t.type === 'IN' && t.subType === 'é€€æ–™å…¥åº“') {
              return fixFloat(acc - w);
          }
          return acc;
        }, 0);
      };
      
      const parseRecordDetails = (t) => {
          let outParty = 'â€”';
          let inParty = 'â€”';
          let businessType = t.subType || (t.type === 'IN' ? 'å…¥åº“' : 'å‡ºåº“');
          let cleanNotes = t.notes || '';
          
          const transferTo = t.notes.match(/^\[è°ƒå‡ºè‡³\]\s*(.*?)(?:\s+-\s+|$)/);
          const transferFrom = t.notes.match(/^\[è°ƒå…¥è‡ª\]\s*(.*?)(?:\s+-\s+|$)/);
          const directSource = t.notes.match(/^\[ç›´å‘æº\]\s*(.*?)(?:\s+-\s+|$)/);
          const directRel = t.notes.match(/^\[ç›´å‘-å…³è”å…¥åº“\]\s*.*?(?:\s+-\s+|$)/);
          const disposalSource = t.notes.match(/^\[åºŸæ—§å¤„ç½®-å»å‘\]\s*æ¥æº:(.*?)(?:\s+-\s+|$)/);

          if (t.type === 'IN') {
              if (t.subType === 'é‡‡è´­å…¥åº“' || t.subType === 'è°ƒæ‹¨å…¥åº“') {
                  outParty = t.party;
                  inParty = 'åº“å­˜(ä»“åº“)';
              } else if (t.subType === 'é€€æ–™å…¥åº“') {
                  outParty = t.party;
                  inParty = 'åº“å­˜(ä»“åº“)';
              }
          } else { 
              if (t.subType === 'æ­£å¸¸é¢†ç”¨') {
                  outParty = 'åº“å­˜(ä»“åº“)';
                  inParty = t.party;
                  if (directRel) cleanNotes = t.notes.replace(/^\[ç›´å‘-å…³è”å…¥åº“\]\s*.*?(?:\s+-\s+|$)/, '');
              } else if (t.subType === 'ç›´æ”¶ç›´å‘') {
                  outParty = directSource ? directSource[1] : 'ç›´å‘(ä¾›åº”å•†)';
                  inParty = t.party;
                  if (directSource) cleanNotes = t.notes.replace(/^\[ç›´å‘æº\]\s*.*?(?:\s+-\s+|$)/, '');
              } else if (t.subType === 'å†…éƒ¨è°ƒæ‹¨-å‡º') {
                  outParty = t.party;
                  inParty = transferTo ? transferTo[1] : 'æœªçŸ¥æ¥æ”¶æ–¹';
                  if (transferTo) cleanNotes = t.notes.replace(/^\[è°ƒå‡ºè‡³\]\s*.*?(?:\s+-\s+|$)/, '');
              } else if (t.subType === 'å†…éƒ¨è°ƒæ‹¨-å…¥') {
                  outParty = transferFrom ? transferFrom[1] : 'æœªçŸ¥æ¥æºæ–¹';
                  inParty = t.party;
                  if (transferFrom) cleanNotes = t.notes.replace(/^\[è°ƒå…¥è‡ª\]\s*.*?(?:\s+-\s+|$)/, '');
              } else if (t.subType === 'å¤„ç½®/é”€å”®') {
                  outParty = 'åº“å­˜(ä»“åº“)';
                  inParty = t.party;
                  if (disposalSource) cleanNotes = t.notes.replace(/^\[åºŸæ—§å¤„ç½®-å»å‘\]\s*.*?(?:\s+-\s+|$)/, '');
              } else if (t.subType === 'è°ƒæ‹¨å‡ºåº“') {
                  outParty = 'åº“å­˜(ä»“åº“)';
                  inParty = t.party;
              } else if (t.subType === 'ç›˜äº') {
                  outParty = 'åº“å­˜(ä»“åº“)';
                  inParty = 'æŸè€—';
              }
          }
          if (!cleanNotes && t.notes && !t.notes.startsWith('[')) cleanNotes = t.notes;
          return { outParty, inParty, businessType, cleanNotes };
      };

      // --- Components ---

      const Sidebar = ({ activeTab, onTabChange }) => {
        const menu = [
          { id: 'dashboard', label: 'æ€»è§ˆçœ‹æ¿', icon: <IconDashboard /> },
          { id: 'entry', label: 'å‡ºå…¥åº“ç™»è®°', icon: <IconPlus /> },
          { id: 'records', label: 'å°è´¦æ˜ç»†', icon: <IconList /> }, 
          { id: 'settings', label: 'åŸºç¡€è®¾ç½®', icon: <IconSettings /> },
        ];

        return (
          <div className="w-64 bg-slate-900 text-white flex flex-col h-full shadow-xl z-10">
            <div className="p-6 border-b border-slate-700">
              <h1 className="text-xl font-bold flex items-center gap-2">
                ğŸ—ï¸ é’¢ç­‹ç®¡å®¶
              </h1>
              <div className="text-xs text-slate-400 mt-1">æ™ºæ…§å·¥åœ°åº“å­˜ç³»ç»Ÿ (ç¦»çº¿ç‰ˆ)</div>
            </div>
            <nav className="flex-1 p-4 space-y-2">
              {menu.map(item => (
                <button
                  key={item.id}
                  onClick={() => onTabChange(item.id)}
                  className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${
                    activeTab === item.id 
                      ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' 
                      : 'text-slate-300 hover:bg-slate-800'
                  }`}
                >
                  {item.icon}
                  <span className="font-medium">{item.label}</span>
                </button>
              ))}
            </nav>
            <div className="p-4 border-t border-slate-800 text-xs text-center text-slate-500">
              <p>v2.2.1 ç¦»çº¿APKç‰ˆ</p>
              <p className="mt-1 text-slate-600">æ•°æ®å­˜å‚¨äºæœ¬åœ°è®¾å¤‡</p>
            </div>
          </div>
        );
      };

      const Dashboard = ({ transactions, masterData, onUpdateMasterData }) => {
        // State for Team Limit Editing
        const [editingItemLimit, setEditingItemLimit] = useState(null);
        
        // State for Carousel
        const [carouselIndex, setCarouselIndex] = useState(0);

        const stats = useMemo(() => {
          let totalIn = 0;
          let totalOut = 0;
          let externalIn = 0; 
          
          // New Metrics
          let totalTransferOut = 0; // è°ƒæ‹¨å‡ºåº“ (å¤–éƒ¨)
          let totalTransferIn = 0;  // è°ƒæ‹¨å…¥åº“ (å¤–éƒ¨)
          let totalDisposal = 0;    // å¤„ç½®/é”€å”®

          const stockBySpec = {};
          const usageByTeam = {};

          transactions.forEach(t => {
            const w = fixFloat(t.weight);
            const absW = Math.abs(w);

            if (t.type === 'IN') {
              totalIn = fixFloat(totalIn + w);
              if (t.subType === 'é€€æ–™å…¥åº“') {
                 usageByTeam[t.party] = fixFloat((usageByTeam[t.party] || 0) - absW);
              } else {
                 externalIn = fixFloat(externalIn + w);
                 // ç´¯è®¡è°ƒå…¥ (å¤–éƒ¨)
                 if (t.subType === 'è°ƒæ‹¨å…¥åº“') {
                     totalTransferIn = fixFloat(totalTransferIn + w);
                 }
              }
            }
            if (t.type === 'OUT') {
              totalOut = fixFloat(totalOut + w);
              
              if (t.subType === 'æ­£å¸¸é¢†ç”¨' || t.subType === 'ç›´æ”¶ç›´å‘' || t.subType === 'å†…éƒ¨è°ƒæ‹¨-å…¥' || t.subType === 'è°ƒæ‹¨å‡ºåº“') {
                 usageByTeam[t.party] = fixFloat((usageByTeam[t.party] || 0) + absW);
              }
              if (t.subType === 'å†…éƒ¨è°ƒæ‹¨-å‡º') {
                 usageByTeam[t.party] = fixFloat((usageByTeam[t.party] || 0) + w); 
              }

              // New Metrics Calculation
              if (t.subType === 'è°ƒæ‹¨å‡ºåº“') {
                  totalTransferOut = fixFloat(totalTransferOut + absW);
              }
              if (t.subType === 'å¤„ç½®/é”€å”®') {
                  totalDisposal = fixFloat(totalDisposal + absW);
              }
            }
            
            const modifier = t.type === 'IN' ? 1 : -1;
            stockBySpec[t.spec] = fixFloat((stockBySpec[t.spec] || 0) + (w * modifier));
          });

          return { 
              totalIn, totalOut, externalIn, 
              currentStock: fixFloat(totalIn - totalOut), 
              stockBySpec, usageByTeam,
              totalTransferOut, totalTransferIn, totalDisposal
          };
        }, [transactions]);

        // Carousel Logic
        const teamUsageData = useMemo(() => {
            const limits = masterData.teamLimits || {};
            return Object.entries(stats.usageByTeam)
                .map(([team, usage]) => {
                    const limit = limits[team] || 0;
                    const percent = limit > 0 ? (usage / limit) * 100 : 0;
                    return { team, usage, limit, percent };
                })
                .sort((a, b) => b.usage - a.usage); // Sort by usage high to low
        }, [stats.usageByTeam, masterData.teamLimits]);

        useEffect(() => {
            if (teamUsageData.length === 0) return;
            const interval = setInterval(() => {
                setCarouselIndex(prev => (prev + 1) % teamUsageData.length);
            }, 4000); // Rotate every 4 seconds
            return () => clearInterval(interval);
        }, [teamUsageData.length]);

        const handleTeamClick = (team) => {
            const currentLimit = masterData.teamLimits?.[team] || '';
            setEditingItemLimit({ team, limit: currentLimit });
        };

        const saveLimit = (e) => {
            e.preventDefault();
            if (!editingItemLimit) return;
            const newLimit = parseFloat(editingItemLimit.limit);
            
            const newMasterData = {
                ...masterData,
                teamLimits: {
                    ...(masterData.teamLimits || {}),
                    [editingItemLimit.team]: newLimit
                }
            };
            onUpdateMasterData(newMasterData);
            setEditingItemLimit(null);
        };

        const currentCarouselItem = teamUsageData[carouselIndex];

        return (
          <div className="p-8 overflow-y-auto h-full bg-gray-50 relative">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">åº“å­˜æ¦‚è§ˆ</h2>
            
            {/* Row 1: Basic Stock Info */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                <span className="text-sm text-gray-500 font-medium">å½“å‰æ€»åº“å­˜</span>
                <span className="text-3xl font-bold text-blue-600 mt-2">{stats.currentStock.toFixed(3)} <span className="text-sm text-gray-400">å¨</span></span>
              </div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-purple-100 flex flex-col">
                <span className="text-sm text-gray-500 font-medium">å¤–éƒ¨å…¥åœº(ä¸å«é€€åº“)</span>
                <span className="text-3xl font-bold text-purple-600 mt-2">{stats.externalIn.toFixed(3)} <span className="text-sm text-gray-400">å¨</span></span>
              </div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                <span className="text-sm text-gray-500 font-medium">ç´¯è®¡å…¥åº“(å«é€€åº“)</span>
                <span className="text-3xl font-bold text-green-600 mt-2">{stats.totalIn.toFixed(3)} <span className="text-sm text-gray-400">å¨</span></span>
              </div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                <span className="text-sm text-gray-500 font-medium">ç´¯è®¡é¢†ç”¨/å‡ºåº“</span>
                <span className="text-3xl font-bold text-orange-600 mt-2">{stats.totalOut.toFixed(3)} <span className="text-sm text-gray-400">å¨</span></span>
              </div>
            </div>

            {/* Row 2: External Transfers & Disposal & Carousel */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
               <div className="bg-white p-6 rounded-xl shadow-sm border border-indigo-100 flex flex-col">
                  <span className="text-sm text-gray-500 font-medium">ä»å…¶ä»–å•ä½è°ƒå…¥ (å¤–éƒ¨)</span>
                  <span className="text-2xl font-bold text-indigo-600 mt-2">{stats.totalTransferIn.toFixed(3)} <span className="text-sm text-gray-400">å¨</span></span>
               </div>
               <div className="bg-white p-6 rounded-xl shadow-sm border border-cyan-100 flex flex-col">
                  <span className="text-sm text-gray-500 font-medium">è°ƒå‡ºè‡³å…¶ä»–å•ä½ (å¤–éƒ¨)</span>
                  <span className="text-2xl font-bold text-cyan-600 mt-2">{stats.totalTransferOut.toFixed(3)} <span className="text-sm text-gray-400">å¨</span></span>
               </div>
               <div className="bg-white p-6 rounded-xl shadow-sm border border-red-100 flex flex-col">
                  <span className="text-sm text-gray-500 font-medium">ç´¯è®¡å¤„ç½®/é”€å”®</span>
                  <span className="text-2xl font-bold text-red-600 mt-2">{stats.totalDisposal.toFixed(3)} <span className="text-sm text-gray-400">å¨</span></span>
               </div>
               
               {/* Carousel Card */}
               <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-xl shadow-lg text-white flex flex-col justify-between relative overflow-hidden">
                   <div className="absolute top-0 right-0 p-2 opacity-10"><IconChart /></div>
                   <span className="text-xs text-slate-400 font-bold uppercase tracking-wider">é˜Ÿä¼é™é¢æ‰§è¡Œç‡ (è½®æ’­)</span>
                   
                   {currentCarouselItem ? (
                       <div className="mt-2 animate-fade-in">
                           <div className="flex justify-between items-end mb-1">
                                <span className="font-bold text-lg truncate pr-2">{currentCarouselItem.team}</span>
                                <span className="text-2xl font-bold text-blue-400">{currentCarouselItem.percent.toFixed(1)}%</span>
                           </div>
                           <div className="w-full bg-slate-700 rounded-full h-2 mb-2">
                                <div className={`h-2 rounded-full transition-all duration-1000 ${currentCarouselItem.percent > 100 ? 'bg-red-500' : 'bg-blue-500'}`} style={{ width: `${Math.min(currentCarouselItem.percent, 100)}%` }}></div>
                           </div>
                           <div className="flex justify-between text-xs text-slate-400">
                                <span>å·²é¢†: {currentCarouselItem.usage.toFixed(3)}</span>
                                <span>é™é¢: {currentCarouselItem.limit > 0 ? currentCarouselItem.limit : 'æœªè®¾ç½®'}</span>
                           </div>
                       </div>
                   ) : (
                       <div className="mt-4 text-sm text-slate-500 text-center">æš‚æ— é¢†ç”¨æ•°æ®</div>
                   )}
               </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 className="font-bold text-lg mb-4 text-gray-800 border-b pb-2">åˆ†è§„æ ¼åº“å­˜ (å¨)</h3>
                <div className="space-y-3">
                  {Object.keys(stats.stockBySpec).length === 0 && <div className="text-gray-400 text-sm py-4">æš‚æ— æ•°æ®</div>}
                  {Object.entries(stats.stockBySpec).map(([spec, amount]) => (
                    <div key={spec} className="flex items-center justify-between">
                      <span className="font-mono text-gray-600 bg-gray-100 px-2 py-1 rounded text-sm">{spec}</span>
                      <div className="flex-1 mx-4 h-2 bg-gray-100 rounded-full overflow-hidden">
                        <div 
                          className="h-full bg-blue-500 rounded-full" 
                          style={{ width: `${Math.min(100, (amount / stats.currentStock) * 100 || 0)}%` }}
                        ></div>
                      </div>
                      <span className={`font-bold w-20 text-right ${amount < 0 ? 'text-red-500' : 'text-gray-700'}`}>{amount.toFixed(3)}</span>
                    </div>
                  ))}
                </div>
              </div>

              <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <div className="flex justify-between items-center border-b pb-2 mb-4">
                    <h3 className="font-bold text-lg text-gray-800">é˜Ÿä¼é¢†ç”¨æ’è¡Œ (å¨)</h3>
                    <span className="text-xs text-blue-500 bg-blue-50 px-2 py-1 rounded animate-pulse">æç¤ºï¼šç‚¹å‡»é˜Ÿä¼åè®¾ç½®é™é¢</span>
                </div>
                <div className="space-y-3 max-h-96 overflow-y-auto">
                   {Object.keys(stats.usageByTeam).length === 0 && <div className="text-gray-400 text-sm py-4">æš‚æ— æ•°æ®</div>}
                  {Object.entries(stats.usageByTeam)
                    .sort(([,a], [,b]) => b - a)
                    .map(([team, amount], idx) => {
                      const limit = masterData.teamLimits?.[team] || 0;
                      const isOverLimit = limit > 0 && amount > limit;
                      return (
                        <div key={team} className="flex items-center justify-between group">
                          <div className="flex items-center gap-3">
                            <span className={`flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold ${idx < 3 ? 'bg-orange-100 text-orange-600' : 'bg-gray-100 text-gray-500'}`}>
                              {idx + 1}
                            </span>
                            <div className="flex flex-col">
                                <span 
                                    className="text-gray-700 font-medium cursor-pointer hover:text-blue-600 hover:underline decoration-blue-400 underline-offset-2"
                                    onClick={() => handleTeamClick(team)}
                                    title="ç‚¹å‡»ä¿®æ”¹é™é¢"
                                >
                                    {team}
                                </span>
                                {limit > 0 && (
                                    <span className={`text-[10px] ${isOverLimit ? 'text-red-500 font-bold' : 'text-gray-400'}`}>
                                        é™é¢: {limit} / è¿›åº¦: {((amount/limit)*100).toFixed(0)}%
                                    </span>
                                )}
                            </div>
                          </div>
                          <span className={`font-bold ${isOverLimit ? 'text-red-600' : 'text-gray-900'}`}>{amount.toFixed(3)}</span>
                        </div>
                      );
                  })}
                </div>
              </div>
            </div>

            {/* Edit Limit Modal */}
            {editingItemLimit && (
                <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
                    <div className="bg-white p-6 rounded-xl shadow-xl w-80 animate-fade-in-up">
                        <h3 className="font-bold text-gray-800 mb-4">è®¾ç½®é¢†ç”¨é™é¢ (æ€»é‡)</h3>
                        <div className="mb-4">
                            <label className="block text-xs font-bold text-gray-500 mb-1">é˜Ÿä¼: {editingItemLimit.team}</label>
                            <input 
                                type="number" 
                                autoFocus
                                placeholder="è¾“å…¥æœ€å¤§å…è®¸é¢†ç”¨é‡"
                                className="w-full border border-gray-300 rounded px-3 py-2 outline-none focus:border-blue-500"
                                value={editingItemLimit.limit}
                                onChange={e => setEditingItemLimit({...editingItemLimit, limit: e.target.value})}
                            />
                        </div>
                        <div className="flex gap-2">
                             <button onClick={() => setEditingItemLimit(null)} className="flex-1 py-2 bg-gray-100 text-gray-600 rounded text-sm hover:bg-gray-200">å–æ¶ˆ</button>
                             <button onClick={saveLimit} className="flex-1 py-2 bg-blue-600 text-white font-bold rounded text-sm hover:bg-blue-700">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            )}

          </div>
        );
      };

      const EntryForm = ({ masterData, transactions, onAdd }) => {
        const [mode, setMode] = useState('IN'); 
        const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
        const [subType, setSubType] = useState('é‡‡è´­å…¥åº“');
        const [isDirect, setIsDirect] = useState(false);
        const [directTargetTeam, setDirectTargetTeam] = useState('');
        const [disposalTeam, setDisposalTeam] = useState(''); // New State for Disposal Source Team
        const [party, setParty] = useState(''); 
        const [sourceParty, setSourceParty] = useState(''); 
        const [targetParty, setTargetParty] = useState(''); 
        const [notes, setNotes] = useState('');
        const [items, setItems] = useState(Array(8).fill({ spec: '', weight: '', max: null }));

        const clearOnFocus = (setter) => () => setter('');

        const currentParties = useMemo(() => {
           if (mode === 'IN') {
               if (subType === 'é€€æ–™å…¥åº“') return masterData.teams;
               if (subType === 'è°ƒæ‹¨å…¥åº“') return masterData.partners || [];
               return masterData.sources;
           }
           if (mode === 'OUT') {
               if (subType === 'å¤„ç½®/é”€å”®') return masterData.recyclers || [];
               if (subType === 'è°ƒæ‹¨å‡ºåº“') return masterData.partners || [];
               return masterData.teams;
           }
           return masterData.teams;
        }, [mode, subType, masterData]);

        // Effect to set default spec to "åºŸæ—§é’¢æ" when Disposal/Sales is selected
        useEffect(() => {
            if (mode === 'OUT' && subType === 'å¤„ç½®/é”€å”®') {
                setItems(prevItems => prevItems.map(item => ({ ...item, spec: 'åºŸæ—§é’¢æ', max: null })));
            }
        }, [mode, subType]);

        const handleModeChange = (newMode) => {
          setMode(newMode);
          setParty('');
          setSourceParty('');
          setTargetParty('');
          setIsDirect(false);
          setDirectTargetTeam('');
          setDisposalTeam(''); // Reset disposal team
          setItems(Array(8).fill({ spec: '', weight: '', max: null })); 
          setNotes('');
          
          if (newMode === 'IN') setSubType('é‡‡è´­å…¥åº“');
          else if (newMode === 'OUT') setSubType('æ­£å¸¸é¢†ç”¨');
          else if (newMode === 'TRANSFER') setSubType('å†…éƒ¨è°ƒæ‹¨');
        };

        const updateItem = (index, field, value) => {
            const newItems = [...items];
            let newWeight = newItems[index].weight;
            let maxStock = newItems[index].max;

            // Logic: Auto-fill quantity when spec is selected for OUT/TRANSFER or Return Material
            if (field === 'spec') {
                const isReturn = (mode === 'IN' && subType === 'é€€æ–™å…¥åº“');
                const isOutOrTransfer = (mode === 'OUT' || mode === 'TRANSFER');
                const isDisposal = (mode === 'OUT' && subType === 'å¤„ç½®/é”€å”®');
                
                if (isDisposal) {
                    // Disposal mode ignores stock limits
                    maxStock = null;
                } else if (isOutOrTransfer || isReturn) {
                    let targetParty = party;
                    if (mode === 'TRANSFER') targetParty = sourceParty;

                    if (!targetParty) {
                        alert(mode === 'TRANSFER' ? "è¯·å…ˆé€‰æ‹©'è°ƒå‡ºé˜Ÿä¼'" : (isReturn ? "è¯·å…ˆé€‰æ‹©'é€€æ–™é˜Ÿä¼'" : "è¯·å…ˆé€‰æ‹©'é¢†ç”¨é˜Ÿä¼'"));
                    } else {
                        let current = 0;
                        if (isReturn || mode === 'TRANSFER') {
                            current = calculateTeamStock(transactions, targetParty, value);
                        } else if (mode === 'OUT') {
                            current = calculateStock(transactions, value);
                        }

                        if (current <= 0) {
                             maxStock = 0;
                             newWeight = ''; 
                        } else {
                             maxStock = current;
                             newWeight = current; 
                        }
                    }
                } else {
                    maxStock = null; 
                }
            }

            if (field === 'weight') {
                newWeight = value;
                // CHECK HERE: Fix bug where integer (5) snaps to float (4.9999...) due to float errors
                // Added buffer of 0.0001
                if (maxStock !== null && parseFloat(value) > maxStock + 0.0001) {
                    newWeight = maxStock; // Force limit
                }
            }

            newItems[index] = { ...newItems[index], [field]: value, weight: newWeight, max: maxStock };
            setItems(newItems);
        };
        
        // --- Serial No Generator ---
        const generateSerialNo = (type, dateStr, existingTransactions) => {
            const prefix = type === 'IN' ? 'RK' : 'CK';
            const datePart = dateStr.replace(/-/g, ''); // 2024-01-01 -> 20240101
            const base = `${prefix}${datePart}`;
            
            // Find counts for this specific day/type combo by filtering prefix
            const relevant = existingTransactions
                .filter(t => t.serialNo && t.serialNo.startsWith(base))
                .map(t => parseInt(t.serialNo.slice(-3), 10))
                .filter(n => !isNaN(n));
                
            const maxSeq = relevant.length > 0 ? Math.max(...relevant) : 0;
            const nextSeq = (maxSeq + 1).toString().padStart(3, '0');
            
            return `${base}${nextSeq}`;
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          const validItems = items.filter(item => item.spec && item.weight && parseFloat(item.weight) !== 0);

          if (validItems.length === 0) return alert("è¯·è‡³å°‘å½•å…¥ä¸€è¡Œæœ‰æ•ˆçš„è§„æ ¼å’Œé‡é‡");
          
          // Check for precision exceeding 3 decimal places
          const hasInvalidPrecision = validItems.some(item => {
             const parts = item.weight.toString().split('.');
             return parts.length === 2 && parts[1].length > 3;
          });

          if (hasInvalidPrecision) {
              return alert("ç²¾åº¦é™åˆ¶è­¦å‘Š: ç³»ç»Ÿä»…æ”¯æŒæœ€å¤š 3 ä½å°æ•°ï¼ˆç²¾ç¡®åˆ°å…¬æ–¤ï¼‰ï¼Œè¯·æ£€æŸ¥è¾“å…¥ã€‚");
          }

          const tempStock = {}; 
          validItems.forEach(item => {
             const w = parseFloat(item.weight);
             tempStock[item.spec] = (tempStock[item.spec] || 0) + w;
          });
          
          const isReturn = (mode === 'IN' && subType === 'é€€æ–™å…¥åº“');
          const isDisposal = (mode === 'OUT' && subType === 'å¤„ç½®/é”€å”®');

          if ((mode === 'OUT' || mode === 'TRANSFER' || isReturn) && !isDisposal) {
              for (const [spec, requiredWeight] of Object.entries(tempStock)) {
                  let current = 0;
                  let checkName = 'ä»“åº“åº“å­˜';
                  
                  if (mode === 'TRANSFER') {
                      if (!sourceParty) return alert("è¯·é€‰æ‹©è°ƒå‡ºé˜Ÿä¼");
                      current = calculateTeamStock(transactions, sourceParty, spec);
                      checkName = `é˜Ÿä¼[${sourceParty}]æŒæœ‰é‡`;
                  } else if (isReturn) {
                      if (!party) return alert("è¯·é€‰æ‹©é€€æ–™é˜Ÿä¼");
                      current = calculateTeamStock(transactions, party, spec);
                      checkName = `é˜Ÿä¼[${party}]æŒæœ‰é‡`;
                  } else {
                      current = calculateStock(transactions, spec);
                  }
                  
                  if (current < requiredWeight - 0.0001) {
                      return alert(`åº“å­˜ä¸è¶³è­¦å‘Šï¼\n${checkName}ä¸è¶³\nè§„æ ¼: ${spec}\nå½“å‰å¯ç”¨: ${current.toFixed(3)} å¨\næœ¬æ¬¡éœ€æ±‚: ${requiredWeight.toFixed(3)} å¨`);
                  }
              }
          }

          const now = Date.now();
          let processedCount = 0;
          
          // Pre-calculate Serial Numbers base for batch
          // Note: In a loop, we must increment the sequence manually since transactions state isn't updated yet
          let currentTransactions = [...transactions];

          validItems.forEach((item, idx) => {
            // Fix float here to ensure precision before saving
            const w = fixFloat(parseFloat(item.weight));
            
            // Helper to add and update local tracking for serial no generation
            const createAndPush = (overrides) => {
                const type = overrides.type || 'IN';
                const serialNo = generateSerialNo(type, date, currentTransactions);
                const newRecord = {
                    id: crypto.randomUUID(),
                    date,
                    spec: item.spec,
                    weight: w,
                    notes,
                    timestamp: now + idx + (overrides.timestampOffset || 0), 
                    serialNo,
                    ...overrides
                };
                delete newRecord.timestampOffset;
                currentTransactions.push(newRecord);
                return newRecord;
            };

            if (mode === 'TRANSFER') {
                if (!sourceParty || !targetParty) return; 
                // Source Out
                onAdd(createAndPush({
                    type: 'OUT',
                    party: sourceParty,
                    weight: fixFloat(-w), 
                    subType: 'å†…éƒ¨è°ƒæ‹¨-å‡º',
                    notes: `[è°ƒå‡ºè‡³] ${targetParty} - ${notes}`,
                    timestampOffset: 0
                }));
                // Target In
                onAdd(createAndPush({
                    type: 'OUT', 
                    party: targetParty,
                    weight: w,
                    subType: 'å†…éƒ¨è°ƒæ‹¨-å…¥',
                    notes: `[è°ƒå…¥è‡ª] ${sourceParty} - ${notes}`,
                    timestampOffset: 1,
                    serialNo: generateSerialNo('IN', date, currentTransactions) // Force RK for receiver
                }));

            } else if (mode === 'IN') {
                if (!party) return;
                onAdd(createAndPush({ type: 'IN', party: party, subType: subType }));
                if (isDirect && directTargetTeam) {
                    onAdd(createAndPush({
                        type: 'OUT',
                        party: directTargetTeam,
                        subType: 'æ­£å¸¸é¢†ç”¨', // Changed from ç›´æ”¶ç›´å‘ to æ­£å¸¸é¢†ç”¨
                        notes: `[ç›´å‘-å…³è”å…¥åº“] æ¥æº:${party} - ${notes}`,
                        timestampOffset: 100
                    }));
                }

            } else if (mode === 'OUT') {
                if (!party) return;
                if (isDisposal) {
                    if (!disposalTeam) return alert("è¯·é€‰æ‹©è¢«å¤„ç½®é˜Ÿä¼");
                    // Dual Record Creation for Disposal
                    // 1. Team Return (Negative impact on team, Positive on Warehouse)
                    onAdd(createAndPush({
                        type: 'IN',
                        subType: 'é€€æ–™å…¥åº“',
                        party: disposalTeam, // The team losing the material
                        spec: 'åºŸæ—§é’¢æ',
                        weight: w,
                        notes: `[åºŸæ—§å¤„ç½®-æ¥æº] ${notes}`,
                        timestampOffset: 0
                    }));
                    // 2. Warehouse Sale (Negative impact on Warehouse, 0 Net on Warehouse)
                    onAdd(createAndPush({
                        type: 'OUT',
                        subType: 'å¤„ç½®/é”€å”®',
                        party: party, // The recycler
                        spec: 'åºŸæ—§é’¢æ',
                        weight: w,
                        notes: `[åºŸæ—§å¤„ç½®-å»å‘] æ¥æº:${disposalTeam} - ${notes}`,
                        timestampOffset: 1,
                        serialNo: generateSerialNo('OUT', date, currentTransactions)
                    }));
                } else {
                    onAdd(createAndPush({ type: 'OUT', party: party, subType: subType }));
                }
            }
            processedCount++;
          });

          if (processedCount > 0) {
              alert("ç™»è®°æˆåŠŸï¼");
              setItems(Array(8).fill({ spec: '', weight: '', max: null }));
              setNotes('');
              setParty('');
              setSourceParty('');
              setTargetParty('');
              setDirectTargetTeam('');
              setDisposalTeam('');
          }
        };
        
        let targetLabel = 'é¢†ç”¨é˜Ÿä¼ / æ¥æ”¶æ–¹';
        let placeholderText = 'é€‰æ‹©é˜Ÿä¼';
        if (mode === 'IN') {
             if (subType === 'é€€æ–™å…¥åº“') { targetLabel = 'é€€æ–™é˜Ÿä¼'; placeholderText = 'é€‰æ‹©é˜Ÿä¼'; }
             else if (subType === 'è°ƒæ‹¨å…¥åº“') { targetLabel = 'æ¥æºå¾€æ¥å•ä½'; placeholderText = 'é€‰æ‹©å¾€æ¥å•ä½'; }
             else { targetLabel = 'æ¥æºå•ä½ / ä¾›åº”å•†'; placeholderText = 'é€‰æ‹©ä¾›åº”å•†'; }
        } else if (mode === 'OUT') {
             if (subType === 'å¤„ç½®/é”€å”®') { targetLabel = 'å›æ”¶å•ä½ (æ¥æ”¶æ–¹)'; placeholderText = 'é€‰æ‹©å›æ”¶å•ä½'; }
             else if (subType === 'è°ƒæ‹¨å‡ºåº“') { targetLabel = 'ç›®æ ‡å¾€æ¥å•ä½'; placeholderText = 'é€‰æ‹©å¾€æ¥å•ä½'; }
        }

        return (
          <div className="p-4 md:p-8 h-full bg-gray-50 flex justify-center overflow-y-auto">
            <div className="w-full max-w-4xl bg-white rounded-xl shadow-sm border border-gray-100 p-6 md:p-8 h-fit">
              <h2 className="text-2xl font-bold mb-6 text-gray-800">ğŸ“‹ å‡ºå…¥åº“ & è°ƒæ‹¨ç™»è®°</h2>
              
              <div className="flex bg-gray-100 p-1 rounded-lg mb-8">
                <button type="button" className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${mode === 'IN' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`} onClick={() => handleModeChange('IN')}>å…¥åº“ (æ¥æº)</button>
                <button type="button" className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${mode === 'OUT' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`} onClick={() => handleModeChange('OUT')}>å‡ºåº“ (é¢†ç”¨)</button>
                <button type="button" className={`flex-1 py-2 text-sm font-bold rounded-md transition-all ${mode === 'TRANSFER' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`} onClick={() => handleModeChange('TRANSFER')}><span className="flex items-center justify-center gap-1"><IconSwitch /> å†…éƒ¨è°ƒæ‹¨</span></button>
              </div>

              <form onSubmit={handleSubmit} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">ä¸šåŠ¡æ—¥æœŸ</label>
                    <input type="date" required className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none" value={date} onChange={e => setDate(e.target.value)} />
                  </div>
                  {mode === 'IN' && (
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">å…¥åº“ç±»å‹</label>
                        <select className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none bg-white" value={subType} onChange={e => setSubType(e.target.value)}>
                            <option value="é‡‡è´­å…¥åº“">é‡‡è´­å…¥åº“</option>
                            <option value="è°ƒæ‹¨å…¥åº“">è°ƒæ‹¨å…¥åº“ (å¤–éƒ¨)</option>
                            <option value="é€€æ–™å…¥åº“">é€€æ–™å…¥åº“ (æ‰£å‡é˜Ÿä¼é¢†ç”¨)</option>
                        </select>
                    </div>
                  )}
                  {mode === 'OUT' && (
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">å‡ºåº“ç±»å‹</label>
                        <select className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none bg-white" value={subType} onChange={e => setSubType(e.target.value)}>
                            <option value="æ­£å¸¸é¢†ç”¨">æ­£å¸¸é¢†ç”¨</option>
                            <option value="è°ƒæ‹¨å‡ºåº“">è°ƒæ‹¨å‡ºåº“ (å¤–éƒ¨)</option>
                            <option value="å¤„ç½®/é”€å”®">å¤„ç½®/é”€å”®</option>
                            <option value="ç›˜äº">ç›˜äº</option>
                        </select>
                    </div>
                  )}
                  {mode === 'TRANSFER' && <div className="flex items-end pb-2 text-indigo-600 font-bold text-sm">é˜Ÿä¼é—´å†…éƒ¨è°ƒæ‹¨</div>}
                </div>

                {mode === 'IN' && subType === 'é‡‡è´­å…¥åº“' && (
                    <div className="bg-green-50 p-3 rounded-lg border border-green-100">
                        <label className="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" className="w-4 h-4 text-green-600 rounded focus:ring-green-500" checked={isDirect} onChange={e => setIsDirect(e.target.checked)} />
                            <span className="font-bold text-green-800">å¯ç”¨ç›´æ”¶ç›´å‘ (å…¥åº“åŒæ—¶é¢†ç”¨)</span>
                        </label>
                        {isDirect && (
                             <div className="mt-3">
                                <label className="block text-xs font-bold text-green-700 mb-1">ç›´å‘æ¥æ”¶é˜Ÿä¼</label>
                                <div className="relative">
                                    <input list="teams_direct" required placeholder="é€‰æ‹©æ¥æ”¶é˜Ÿä¼" className="w-full px-4 py-2 rounded-lg border border-green-300 focus:ring-2 focus:ring-green-500 outline-none" value={directTargetTeam} onFocus={clearOnFocus(setDirectTargetTeam)} onChange={e => setDirectTargetTeam(e.target.value)} />
                                    <datalist id="teams_direct">{masterData.teams.map(p => <option key={p} value={p} />)}</datalist>
                                </div>
                            </div>
                        )}
                    </div>
                )}
                
                {mode === 'TRANSFER' ? (
                     <div className="grid grid-cols-2 gap-6">
                       <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2 text-red-600">ä» (è°ƒå‡ºæ–¹)</label>
                          <div className="relative">
                            <input list="teams_source" required placeholder="é€‰æ‹©è°ƒå‡ºé˜Ÿä¼" className="w-full px-4 py-2 rounded-lg border border-red-200 focus:ring-2 focus:ring-red-500 outline-none" value={sourceParty} onFocus={clearOnFocus(setSourceParty)} onChange={e => setSourceParty(e.target.value)} />
                            <datalist id="teams_source">{masterData.teams.map(p => <option key={p} value={p} />)}</datalist>
                          </div>
                       </div>
                       <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2 text-green-600">è‡³ (è°ƒå…¥æ–¹)</label>
                          <div className="relative">
                            <input list="teams_target" required placeholder="é€‰æ‹©è°ƒå…¥é˜Ÿä¼" className="w-full px-4 py-2 rounded-lg border border-green-200 focus:ring-2 focus:ring-green-500 outline-none" value={targetParty} onFocus={clearOnFocus(setTargetParty)} onChange={e => setTargetParty(e.target.value)} />
                            <datalist id="teams_target">{masterData.teams.map(p => <option key={p} value={p} />)}</datalist>
                          </div>
                       </div>
                     </div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">{targetLabel}</label>
                        <div className="relative">
                          <input list="parties" required placeholder={placeholderText} className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none" value={party} onFocus={clearOnFocus(setParty)} onChange={e => setParty(e.target.value)} />
                          <datalist id="parties">{currentParties.map(p => <option key={p} value={p} />)}</datalist>
                        </div>
                      </div>
                      
                      {/* Disposal Source Team Selector */}
                      {mode === 'OUT' && subType === 'å¤„ç½®/é”€å”®' && (
                        <div>
                          <label className="block text-sm font-medium text-red-600 mb-2">è¢«å¤„ç½®é˜Ÿä¼ (æ¥æº)</label>
                          <div className="relative">
                            <input list="disposal_teams" required placeholder="é€‰æ‹©äº§ç”ŸåºŸæ—§çš„é˜Ÿä¼" className="w-full px-4 py-2 rounded-lg border border-red-300 bg-red-50 focus:ring-2 focus:ring-red-500 outline-none" value={disposalTeam} onFocus={clearOnFocus(setDisposalTeam)} onChange={e => setDisposalTeam(e.target.value)} />
                            <datalist id="disposal_teams">{masterData.teams.map(p => <option key={p} value={p} />)}</datalist>
                          </div>
                        </div>
                      )}
                    </div>
                  )}

                <div>
                   <label className="block text-sm font-medium text-gray-700 mb-2">ææ–™æ˜ç»† (æœ€å¤š8è¡Œ)</label>
                   <div className="border border-gray-200 rounded-lg overflow-hidden">
                       <div className="grid grid-cols-12 bg-gray-50 text-xs text-gray-500 font-bold p-2 border-b border-gray-200">
                           <div className="col-span-1 text-center">#</div>
                           <div className="col-span-7 pl-2">é’¢ç­‹è§„æ ¼</div>
                           <div className="col-span-4 pl-2">é‡é‡(å¨)</div>
                       </div>
                       {items.map((item, idx) => (
                           <div key={idx} className="grid grid-cols-12 border-b border-gray-100 last:border-0 p-1 relative">
                               <div className="col-span-1 flex items-center justify-center text-gray-400 text-xs">{idx + 1}</div>
                               <div className="col-span-7 px-1"><input list="specs" placeholder="è§„æ ¼" className="w-full p-1 bg-transparent focus:bg-blue-50 outline-none border-b border-transparent focus:border-blue-300 text-sm font-mono" value={item.spec} onChange={e => updateItem(idx, 'spec', e.target.value)} /></div>
                               <div className="col-span-4 px-1 relative">
                                   <input type="number" step="0.001" placeholder="0.000" className={`w-full p-1 bg-transparent outline-none border-b text-sm font-mono ${item.max !== null && item.weight >= item.max ? 'text-red-600 font-bold' : ''} ${item.max !== null ? 'focus:border-red-300' : 'focus:border-blue-300'} border-transparent`} value={item.weight} onChange={e => updateItem(idx, 'weight', e.target.value)} />
                                   {item.max !== null && <span className="absolute right-1 top-1 text-[10px] text-gray-400 pointer-events-none">/{item.max.toFixed(3)}</span>}
                               </div>
                           </div>
                       ))}
                   </div>
                   <datalist id="specs">{masterData.specs.map(s => <option key={s} value={s} />)}</datalist>
                   {(mode === 'OUT' || mode === 'TRANSFER' || (mode === 'IN' && subType === 'é€€æ–™å…¥åº“')) && subType !== 'å¤„ç½®/é”€å”®' && <p className="text-xs text-gray-400 mt-2 text-right">* æ•°é‡æ å°†è‡ªåŠ¨å¡«å……å½“å‰å¯ç”¨åº“å­˜ï¼Œä¸”ä¸å¯è¶…è¿‡è¯¥å€¼</p>}
                   {subType === 'å¤„ç½®/é”€å”®' && <p className="text-xs text-red-400 mt-2 text-right">* å¤„ç½®/é”€å”®æ¨¡å¼ä¸‹ä¸æ ¡éªŒåº“å­˜ï¼Œé»˜è®¤è§„æ ¼ä¸ºâ€œåºŸæ—§é’¢æâ€ï¼Œè¯·ç¡®è®¤é‡é‡ã€‚</p>}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">å¤‡æ³¨è¯´æ˜</label>
                  <textarea className="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none h-20 resize-none" placeholder="å¡«å†™è½¦è¾†ä¿¡æ¯ã€ä½¿ç”¨éƒ¨ä½ç­‰..." value={notes} onChange={e => setNotes(e.target.value)}></textarea>
                </div>

                <button type="submit" className={`w-full py-3 rounded-lg text-white font-bold shadow-lg transform transition-all active:scale-95 ${mode === 'IN' ? 'bg-green-600 hover:bg-green-700 shadow-green-200' : mode === 'OUT' ? 'bg-blue-600 hover:bg-blue-700 shadow-blue-200' : 'bg-indigo-600 hover:bg-indigo-700 shadow-indigo-200'}`}>ç¡®è®¤æäº¤ ({items.filter(i => i.spec && i.weight).length} è¡Œ)</button>
              </form>
            </div>
          </div>
        );
      };

      const EditModal = ({ transaction, masterData, onClose, onSave }) => {
        const [formData, setFormData] = useState(() => {
            const d = parseRecordDetails(transaction);
            let otherParty = '';
            let noteContent = transaction.notes;

            if (transaction.subType === 'å†…éƒ¨è°ƒæ‹¨-å‡º') {
                const match = transaction.notes.match(/^\[è°ƒå‡ºè‡³\]\s*(.*?)(?:\s+-\s+|$)(.*)/);
                if (match) { otherParty = match[1]; noteContent = match[2] || ''; }
            } else if (transaction.subType === 'å†…éƒ¨è°ƒæ‹¨-å…¥') {
                const match = transaction.notes.match(/^\[è°ƒå…¥è‡ª\]\s*(.*?)(?:\s+-\s+|$)(.*)/);
                if (match) { otherParty = match[1]; noteContent = match[2] || ''; }
            } else if (transaction.subType === 'ç›´æ”¶ç›´å‘') {
                const match = transaction.notes.match(/^\[ç›´å‘æº\]\s*(.*?)(?:\s+-\s+|$)(.*)/);
                if (match) { otherParty = match[1]; noteContent = match[2] || ''; }
            }
            
            if (!otherParty) noteContent = transaction.notes;

            return { 
                ...transaction, 
                otherParty, 
                cleanNotes: noteContent 
            };
        });

        const isComplex = ['å†…éƒ¨è°ƒæ‹¨-å‡º', 'å†…éƒ¨è°ƒæ‹¨-å…¥', 'ç›´æ”¶ç›´å‘'].includes(formData.subType);
        
        const getLabel = () => {
             if (formData.subType === 'å†…éƒ¨è°ƒæ‹¨-å‡º') return { main: 'è°ƒå‡ºæ–¹ (Source)', other: 'è°ƒå…¥æ–¹ (Target)' };
             if (formData.subType === 'å†…éƒ¨è°ƒæ‹¨-å…¥') return { main: 'è°ƒå…¥æ–¹ (Target)', other: 'è°ƒå‡ºæ–¹ (Source)' };
             if (formData.subType === 'ç›´æ”¶ç›´å‘') return { main: 'æ¥æ”¶æ–¹ (Team)', other: 'ç›´å‘æº (Supplier)' };
             return { main: 'ç›¸å…³æ–¹ / é˜Ÿä¼' };
        };
        const labels = getLabel();

        const handleSubmit = (e) => {
            e.preventDefault();
            const w = fixFloat(parseFloat(formData.weight));
            if (!formData.spec || !w) return alert("è¯·å¡«å†™å®Œæ•´çš„è§„æ ¼å’Œé‡é‡");
            
            const parts = formData.weight.toString().split('.');
            if (parts.length === 2 && parts[1].length > 3) {
                 return alert("ç²¾åº¦é™åˆ¶è­¦å‘Š: ç³»ç»Ÿä»…æ”¯æŒæœ€å¤š 3 ä½å°æ•°ï¼ˆç²¾ç¡®åˆ°å…¬æ–¤ï¼‰ï¼Œè¯·æ£€æŸ¥è¾“å…¥ã€‚");
            }

            let finalWeight = w;
            if (transaction.weight < 0 && w > 0) {
                finalWeight = -Math.abs(w);
            } else if (transaction.weight > 0 && w > 0) {
                 finalWeight = Math.abs(w);
            }

            let finalNotes = formData.cleanNotes;
            if (isComplex && formData.otherParty) {
                 let tag = '';
                 if (formData.subType === 'å†…éƒ¨è°ƒæ‹¨-å‡º') tag = '[è°ƒå‡ºè‡³]';
                 else if (formData.subType === 'å†…éƒ¨è°ƒæ‹¨-å…¥') tag = '[è°ƒå…¥è‡ª]';
                 else if (formData.subType === 'ç›´æ”¶ç›´å‘') tag = '[ç›´å‘æº]';
                 
                 finalNotes = `${tag} ${formData.otherParty}${formData.cleanNotes ? ' - ' + formData.cleanNotes : ''}`;
            }

            onSave({ ...formData, weight: finalWeight, notes: finalNotes });
        };

        const absWeight = Math.abs(formData.weight);

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 animate-fade-in-up">
                    <h3 className="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                        <IconEdit /> ä¿®æ”¹æµæ°´è®°å½•
                    </h3>
                    <div className="mb-4 p-2 bg-blue-50 text-blue-700 text-xs rounded border border-blue-100">
                        å½“å‰ä¸šåŠ¡ç±»å‹: <strong>{formData.subType || (formData.type === 'IN' ? 'å…¥åº“' : 'å‡ºåº“')}</strong>
                    </div>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">ä¸šåŠ¡æ—¥æœŸ</label>
                            <input type="date" required value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                        </div>
                         
                        {/* Display Serial No (Read Only) */}
                         <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">å°è´¦åºå· (ç³»ç»Ÿç”Ÿæˆ)</label>
                            <input type="text" readOnly value={formData.serialNo || '-'} className="w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg text-gray-500 font-mono" />
                        </div>

                        {/* Dynamic Party Inputs */}
                        <div className="grid grid-cols-1 gap-4">
                            <div>
                                <label className={`block text-xs font-bold mb-1 ${isComplex ? 'text-blue-600' : 'text-gray-500'}`}>{labels.main}</label>
                                <input list="edit_parties" required value={formData.party} onChange={e => setFormData({...formData, party: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                            </div>
                            {isComplex && (
                                <div>
                                    <label className="block text-xs font-bold text-green-600 mb-1">{labels.other}</label>
                                    <input list="edit_parties" required value={formData.otherParty} onChange={e => setFormData({...formData, otherParty: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none bg-green-50" />
                                </div>
                            )}
                            <datalist id="edit_parties">
                                {[...masterData.teams, ...masterData.sources, ...(masterData.partners||[]), ...(masterData.recyclers||[])].map(p => <option key={p} value={p} />)}
                            </datalist>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">è§„æ ¼</label>
                                <input list="edit_specs" required value={formData.spec} onChange={e => setFormData({...formData, spec: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono" />
                                <datalist id="edit_specs">{masterData.specs.map(s => <option key={s} value={s} />)}</datalist>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">é‡é‡ (å¨)</label>
                                <input type="number" step="0.001" required value={absWeight} onChange={e => setFormData({...formData, weight: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono font-bold" />
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">å¤‡æ³¨</label>
                            <input type="text" value={formData.cleanNotes} onChange={e => setFormData({...formData, cleanNotes: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                        </div>
                        
                        <div className="flex gap-3 mt-6 pt-4 border-t border-gray-100">
                            <button type="button" onClick={onClose} className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition-colors">å–æ¶ˆ</button>
                            <button type="submit" className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition-colors">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </form>
                </div>
            </div>
        );
      };

      // --- MultiSelect Component ---
      const MultiSelect = ({ placeholder, options, value, onChange }) => {
        const [isOpen, setIsOpen] = useState(false);
        const containerRef = useRef(null);

        useEffect(() => {
            const handleClickOutside = (event) => {
                if (containerRef.current && !containerRef.current.contains(event.target)) {
                    setIsOpen(false);
                }
            };
            document.addEventListener("mousedown", handleClickOutside);
            return () => document.removeEventListener("mousedown", handleClickOutside);
        }, []);

        const toggleOption = (option) => {
            const newValue = value.includes(option)
                ? value.filter(v => v !== option)
                : [...value, option];
            onChange(newValue);
        };

        return (
            <div className="relative" ref={containerRef}>
                <div 
                    className="w-full px-2 py-2 border border-gray-300 rounded text-sm focus:border-blue-500 outline-none bg-white cursor-pointer flex justify-between items-center h-[38px]"
                    onClick={() => setIsOpen(!isOpen)}
                >
                    <span className={`block truncate ${(!value || value.length === 0) ? "text-gray-400" : "text-gray-700"}`}>
                        {(!value || value.length === 0) ? placeholder : value.join(', ')}
                    </span>
                    <svg className={`w-4 h-4 text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                </div>
                {isOpen && (
                    <div className="absolute z-50 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                        {options.map(opt => (
                            <label key={opt} className="flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer select-none">
                                <input 
                                    type="checkbox" 
                                    className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300"
                                    checked={value.includes(opt)}
                                    onChange={() => toggleOption(opt)}
                                />
                                <span className="ml-2 text-sm text-gray-700">{opt}</span>
                            </label>
                        ))}
                    </div>
                )}
            </div>
        );
      };

      const RecordsTable = ({ transactions, masterData, onDelete, onUpdate }) => {
        const [viewMode, setViewMode] = useState('list');
        const [groupBy, setGroupBy] = useState('team'); 
        
        // Input States (Controlled)
        const [inputs, setInputs] = useState({
            startDate: '', endDate: '', 
            querySubject: 'åº“å­˜(ä»“åº“)', // Default to Warehouse
            spec: '', notes: '',
            businessType: [] // Changed to array for multi-select
        });
        
        // Active Filter State (Applied on Search)
        const [query, setQuery] = useState(inputs);
        
        // Edit State
        const [editingItem, setEditingItem] = useState(null);

        const allParties = useMemo(() => [...new Set([...masterData.teams, ...masterData.sources, ...(masterData.partners||[]), ...(masterData.recyclers||[]), 'åº“å­˜(ä»“åº“)'])], [masterData]);

        const filterTypeOptions = [
            "é‡‡è´­å…¥åº“", "æ­£å¸¸é¢†ç”¨", "è°ƒæ‹¨å…¥åº“", "è°ƒæ‹¨å‡ºåº“", 
            "å†…éƒ¨è°ƒæ‹¨-å‡º", "å†…éƒ¨è°ƒæ‹¨-å…¥", "é€€æ–™å…¥åº“", 
            "å¤„ç½®/é”€å”®", "ç›˜äº"
        ];

        // Handlers
        const handleSearch = () => setQuery(inputs);
        const handleReset = () => {
             const empty = { startDate: '', endDate: '', querySubject: 'åº“å­˜(ä»“åº“)', spec: '', notes: '', businessType: [] };
             setInputs(empty);
             setQuery(empty);
        };
        const handleInputChange = (field, val) => setInputs(prev => ({...prev, [field]: val}));
        const handleClearSubject = () => {
             setInputs(prev => ({...prev, querySubject: ''}));
        };

        // Compute List
        // If querySubject is present -> Ledger Mode (With balances)
        // If querySubject is empty   -> Global Mode (Just transactions)
        const listWithBalances = useMemo(() => {
            const subject = query.querySubject.trim();
            const isGlobal = !subject;

            // Sort by timestamp
            const sorted = [...transactions].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
            
            // For Ledger Mode
            const balMap = {}; 
            const getBal = (s) => balMap[s] || 0;
            const updateBal = (s, delta) => { balMap[s] = fixFloat(getBal(s) + delta); };

            const processedRows = [];

            sorted.forEach(t => {
                const details = parseRecordDetails(t);
                const s = t.spec;
                const w = Math.abs(t.weight);
                
                // Common filter checks
                const matchDate = (!query.startDate || t.date >= query.startDate) && (!query.endDate || t.date <= query.endDate);
                const matchSpec = !query.spec || t.spec.includes(query.spec);
                const matchNotes = !query.notes || t.notes.includes(query.notes);
                
                // Multi-select business type filter
                const matchType = query.businessType.length === 0 || (t.subType && query.businessType.includes(t.subType));

                if (isGlobal) {
                     // Global Mode: Just filter and map
                     if (matchDate && matchSpec && matchNotes && matchType) {
                         processedRows.push({
                             ...t, ...details,
                             displayType: details.businessType,
                             displayNotes: details.cleanNotes,
                             isGlobal: true
                         });
                     }
                } else {
                    // Ledger Mode: Calculate balance for specific subject
                    
                    // --- Strict Filter to avoid double counting ---
                    // 1. If subject is Warehouse: It's 'relevant' if warehouse is either inParty or outParty (derived).
                    // 2. If subject is a Party (Team/Supplier): It's 'relevant' ONLY if t.party == subject AND (inParty == subject OR outParty == subject).
                    
                    const isSubjectWarehouse = subject === 'åº“å­˜(ä»“åº“)';
                    
                    let isOwnerAndInvolved = false;
                    
                    if (isSubjectWarehouse) {
                        // For warehouse, we rely on the derived analysis because warehouse isn't usually t.party
                        // Exception: Direct Issue (Supplier -> Team) skips Warehouse. details.in=Team, details.out=Supplier. Warehouse not involved. Correct.
                        if (details.inParty === 'åº“å­˜(ä»“åº“)' || details.outParty === 'åº“å­˜(ä»“åº“)') {
                            isOwnerAndInvolved = true;
                        }
                    } else {
                        // For normal parties, strictly check ownership to avoid double counting transfers
                        // This prevents the 'Target' record (where t.party = Target) from showing up in 'Source' ledger, and vice versa.
                        if (t.party === subject) {
                            isOwnerAndInvolved = true;
                        }
                    }

                    if (!isOwnerAndInvolved) return; // Skip this record for this specific ledger

                    let credit = 0; // In
                    let debit = 0;  // Out
                    let isEffective = false;

                    if (details.inParty === subject) {
                        credit = w;
                        updateBal(s, w);
                        isEffective = true;
                    } else if (details.outParty === subject) {
                        debit = w;
                        updateBal(s, -w);
                        isEffective = true;
                    }

                    if (isEffective) {
                        if (matchDate && matchSpec && matchNotes && matchType) {
                            processedRows.push({
                                ...t,
                                ...details,
                                displayType: details.businessType,
                                displayNotes: details.cleanNotes,
                                ledgerCredit: credit,
                                ledgerDebit: debit,
                                ledgerBalance: getBal(s),
                                opponent: details.inParty === subject ? details.outParty : details.inParty,
                                isGlobal: false
                            });
                        }
                    }
                }
            });

            return processedRows.reverse(); // Show newest first
        }, [transactions, query]);

        // Logic for Summary Report (Actual Stock Calculation)
        const summaryData = useMemo(() => {
            const start = query.startDate || '0000-01-01';
            const end = query.endDate || '9999-12-31';
            
            // Structure: Key -> { open: 0, in: 0, out: 0 }
            const statsMap = {};

            const add = (p, s, v, date) => {
                if (!p) return;
                const k = `${p}|${s}`;
                if (!statsMap[k]) statsMap[k] = { open: 0, in: 0, out: 0 };
                
                if (date < start) {
                    statsMap[k].open = fixFloat(statsMap[k].open + v);
                } else if (date <= end) {
                    // Within Period
                    if (v >= 0) {
                        statsMap[k].in = fixFloat(statsMap[k].in + v);
                    } else {
                        statsMap[k].out = fixFloat(statsMap[k].out + v);
                    }
                }
                // Date > end is ignored for this report
            };

            transactions.forEach(t => {
                const s = t.spec;
                const w = fixFloat(t.weight);
                const absW = Math.abs(w);
                const d = t.date;
                
                if (t.type === 'IN') {
                    if (t.subType === 'é‡‡è´­å…¥åº“' || t.subType === 'è°ƒæ‹¨å…¥åº“') {
                        add('åº“å­˜(ä»“åº“)', s, absW, d);
                    } else if (t.subType === 'é€€æ–™å…¥åº“') {
                        add('åº“å­˜(ä»“åº“)', s, absW, d);
                        add(t.party, s, -absW, d);
                    }
                } else { 
                    if (t.subType === 'æ­£å¸¸é¢†ç”¨') {
                        add('åº“å­˜(ä»“åº“)', s, -absW, d);
                        add(t.party, s, absW, d);
                    } else if (t.subType === 'ç›´æ”¶ç›´å‘') {
                        add(t.party, s, absW, d);
                    } else if (t.subType === 'å†…éƒ¨è°ƒæ‹¨-å‡º') {
                        add(t.party, s, w, d); // w is negative
                    } else if (t.subType === 'å†…éƒ¨è°ƒæ‹¨-å…¥') {
                        add(t.party, s, w, d); // w is positive
                    } else if (t.subType === 'è°ƒæ‹¨å‡ºåº“') {
                        add('åº“å­˜(ä»“åº“)', s, -absW, d);
                        add(t.party, s, absW, d);
                    } else if (t.subType === 'å¤„ç½®/é”€å”®' || t.subType === 'ç›˜äº') {
                        add('åº“å­˜(ä»“åº“)', s, -absW, d);
                    }
                }
            });

            // Convert map to array
            let results = Object.entries(statsMap).map(([key, val]) => {
                const [party, spec] = key.split('|');
                const closing = fixFloat(val.open + val.in + val.out);
                return { party, spec, ...val, closing };
            });

            // Filter results based on User Input
            if (query.querySubject) {
                results = results.filter(r => r.party.includes(query.querySubject.trim()));
            }
            if (query.spec) {
                results = results.filter(r => r.spec.includes(query.spec.trim()));
            }

            // Only show rows that have some activity or non-zero balance
            return results.filter(r => Math.abs(r.open) > 0.001 || Math.abs(r.in) > 0.001 || Math.abs(r.out) > 0.001 || Math.abs(r.closing) > 0.001).sort((a,b) => {
                if (groupBy === 'team') {
                    if (a.party !== b.party) return a.party.localeCompare(b.party);
                    return a.spec.localeCompare(b.spec);
                } else {
                    if (a.spec !== b.spec) return a.spec.localeCompare(b.spec);
                    return a.party.localeCompare(b.party);
                }
            });
        }, [transactions, query.endDate, query.startDate, query.querySubject, query.spec, groupBy]);

        const exportCSV = () => {
          if (viewMode === 'list') {
            const isGlobal = !query.querySubject.trim();
            let headers = "";
            let rows = "";
            
            if (isGlobal) {
                headers = "å°è´¦åºå·,æ—¥æœŸ,ä¸šåŠ¡ç±»å‹,è°ƒå‡ºæ–¹,è°ƒå…¥æ–¹,é‡é‡(å¨),è§„æ ¼,å¤‡æ³¨\n";
                rows = listWithBalances.map(t => {
                     return `${t.serialNo || '-'},${t.date},${t.displayType},${t.outParty},${t.inParty},${Math.abs(t.weight)},${t.spec},"${t.displayNotes.replace(/"/g, '""')}"`;
                }).join("\n");
                downloadCSV(headers + rows, `é’¢ç­‹å…¨éƒ¨æµæ°´_${new Date().toISOString().slice(0,10)}.csv`);
            } else {
                headers = "å°è´¦åºå·,æ—¥æœŸ,ä¸šåŠ¡ç±»å‹,æ‘˜è¦,å¯¹æ–¹å•ä½/é¡¹ç›®,æ”¶å…¥(å¨),æ”¯å‡º(å¨),å½“å‰ç»“å­˜(å¨),è§„æ ¼,å¤‡æ³¨\n";
                rows = listWithBalances.map(t => {
                    return `${t.serialNo || '-'},${t.date},${t.displayType},${t.displayNotes.replace(/"/g, '""')},${t.opponent},${t.ledgerCredit || 0},${t.ledgerDebit || 0},${t.ledgerBalance},${t.spec},${t.notes.replace(/"/g, '""')}`;
                }).join("\n");
                downloadCSV(headers + rows, `é’¢ç­‹æµæ°´è´¦_${query.querySubject}_${new Date().toISOString().slice(0,10)}.csv`);
            }
          } else {
            const headers = "ç›¸å…³æ–¹/é˜Ÿä¼,è§„æ ¼,æœŸåˆæŒæœ‰(å¨),æœŸé—´è°ƒå…¥/å¢åŠ (å¨),æœŸé—´è°ƒå‡º/å‡å°‘(å¨),æœŸæœ«æŒæœ‰(å¨)\n";
            const rows = summaryData.map(s => `${s.party},${s.spec},${s.open.toFixed(3)},${s.in.toFixed(3)},${s.out.toFixed(3)},${s.closing.toFixed(3)}`).join("\n");
            downloadCSV(headers + rows, `é’¢ç­‹æ±‡æ€»æŠ¥è¡¨_${new Date().toISOString().slice(0,10)}.csv`);
          }
        };

        const handleDelete = (t) => {
            if(confirm('ç¡®å®šåˆ é™¤æ­¤è®°å½•å—ï¼Ÿæ“ä½œä¸å¯æ¢å¤ã€‚')) onDelete(t.id);
        };

        const handleSaveEdit = (updatedItem) => {
            onUpdate(updatedItem);
            setEditingItem(null);
        };
        
        // Dynamic Column Title
        const summaryColTitle = query.startDate ? "æœŸé—´å‡€å‘ç”Ÿé‡ (å¨)" : "å®é™…æŒæœ‰é‡/åº“å­˜é‡ (å¨)";

        // Calculate Page Totals for Ledger
        const ledgerTotals = useMemo(() => {
            return listWithBalances.reduce((acc, t) => ({
                credit: fixFloat(acc.credit + (t.ledgerCredit || 0)),
                debit: fixFloat(acc.debit + (t.ledgerDebit || 0)),
                vol: fixFloat(acc.vol + Math.abs(t.weight)) // For Global View
            }), { credit: 0, debit: 0, vol: 0 });
        }, [listWithBalances]);

        // Calculate Totals for Summary
        const summaryTotals = useMemo(() => {
            return summaryData.reduce((acc, item) => ({
                open: fixFloat(acc.open + item.open),
                in: fixFloat(acc.in + item.in),
                out: fixFloat(acc.out + item.out),
                closing: fixFloat(acc.closing + item.closing)
            }), { open: 0, in: 0, out: 0, closing: 0 });
        }, [summaryData]);

        const isLedgerView = !!query.querySubject.trim();
        
        // Calculate Total Actual Stock for the selected subject (Ignorning date filters, showing current state)
        const currentSubjectTotalStock = useMemo(() => {
            if (!query.querySubject.trim()) return 0;
            const subject = query.querySubject.trim();
            const cutoffDate = query.endDate; // Support End Date filter
            
            return transactions.reduce((acc, t) => {
                // Strict check: if cutoffDate exists, exclude records after it
                if (cutoffDate && t.date > cutoffDate) return acc;

                const details = parseRecordDetails(t);
                const w = Math.abs(t.weight);
                
                let delta = 0;
                // Strict check: does this transaction belong to the subject?
                const isSubjectWarehouse = subject === 'åº“å­˜(ä»“åº“)';
                let isOwnerAndInvolved = false;
        
                if (isSubjectWarehouse) {
                     if (details.inParty === 'åº“å­˜(ä»“åº“)' || details.outParty === 'åº“å­˜(ä»“åº“)') isOwnerAndInvolved = true;
                } else {
                     if (t.party === subject) isOwnerAndInvolved = true;
                }
                
                if (!isOwnerAndInvolved) return acc;
        
                if (details.inParty === subject) delta = w;
                else if (details.outParty === subject) delta = -w;
                
                return fixFloat(acc + delta);
            }, 0);
        }, [transactions, query.querySubject, query.endDate]);

        return (
          <div className="p-8 h-full bg-gray-50 flex flex-col">
            <div className="flex justify-between items-end mb-6">
              <div>
                <h2 className="text-2xl font-bold text-gray-800">ğŸ” æ˜ç»†å°è´¦ & æŠ¥è¡¨</h2>
                <div className="flex gap-4 mt-2">
                    <button onClick={() => setViewMode('list')} className={`px-3 py-1 rounded-full text-xs font-bold transition-all ${viewMode === 'list' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>
                        {isLedgerView ? 'æµæ°´å°è´¦ (æŒ‡å®šå¯¹è±¡)' : 'å…¨éƒ¨æµæ°´ (å…¨å±€)'}
                    </button>
                    <button onClick={() => setViewMode('summary')} className={`px-3 py-1 rounded-full text-xs font-bold transition-all ${viewMode === 'summary' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>æ±‡æ€»æŠ¥è¡¨</button>
                </div>
              </div>
              <button onClick={exportCSV} className="flex items-center gap-2 bg-slate-800 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors"><IconDownload /> å¯¼å‡º{viewMode === 'list' ? (isLedgerView ? 'å°è´¦' : 'æµæ°´') : 'æŠ¥è¡¨'}</button>
            </div>

            <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 mb-4 space-y-4">
               {/* Search Filters */}
               <div className="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-9 gap-3">
                  <div className="col-span-1">
                      <label className="block text-xs font-bold text-gray-500 mb-1">å¼€å§‹æ—¥æœŸ</label>
                      <input type="date" value={inputs.startDate} onChange={e => handleInputChange('startDate', e.target.value)} className="w-full px-2 py-2 border border-gray-300 rounded text-sm focus:border-blue-500 outline-none" />
                  </div>
                  <div className="col-span-1">
                      <label className="block text-xs font-bold text-gray-500 mb-1">{viewMode === 'summary' ? 'æˆªæ­¢æ—¥æœŸ' : 'ç»“æŸæ—¥æœŸ'}</label>
                      <input type="date" value={inputs.endDate} onChange={e => handleInputChange('endDate', e.target.value)} className="w-full px-2 py-2 border border-gray-300 rounded text-sm focus:border-blue-500 outline-none" />
                  </div>
                  
                  {/* Subject Filter - Optional now with Clear Button */}
                  <div className="col-span-2 relative group">
                      <label className="block text-xs font-bold text-blue-600 mb-1">ç»Ÿè®¡åŸºå‡†å¯¹è±¡ (æ¸…ç©ºæŸ¥çœ‹å…¨éƒ¨)</label>
                      <input list="filter_parties" type="text" placeholder="é»˜è®¤: åº“å­˜(ä»“åº“)" value={inputs.querySubject} onChange={e => handleInputChange('querySubject', e.target.value)} className="w-full px-2 py-2 border border-blue-300 bg-blue-50 rounded text-sm focus:border-blue-500 outline-none font-bold text-blue-900 placeholder-blue-300" />
                      {inputs.querySubject && (
                        <button onClick={handleClearSubject} className="absolute right-2 top-8 text-gray-400 hover:text-red-500 transition-colors">
                            <IconX />
                        </button>
                      )}
                  </div>

                  <div className="col-span-1">
                      <label className="block text-xs font-bold text-gray-500 mb-1">ä¸šåŠ¡ç±»å‹ (å¤šé€‰)</label>
                      <MultiSelect 
                        placeholder="å…¨éƒ¨" 
                        options={filterTypeOptions}
                        value={inputs.businessType} 
                        onChange={val => handleInputChange('businessType', val)} 
                      />
                  </div>
                  
                  <div className="col-span-1"><label className="block text-xs font-bold text-gray-500 mb-1">è§„æ ¼</label><input list="filter_specs" type="text" placeholder="å…³é”®å­—" value={inputs.spec} onChange={e => handleInputChange('spec', e.target.value)} className="w-full px-2 py-2 border border-gray-300 rounded text-sm focus:border-blue-500 outline-none" /></div>
                  <div className="col-span-1"><label className="block text-xs font-bold text-gray-500 mb-1">å¤‡æ³¨</label><input type="text" placeholder="å…³é”®å­—" value={inputs.notes} onChange={e => handleInputChange('notes', e.target.value)} disabled={viewMode==='summary'} className={`w-full px-2 py-2 border border-gray-300 rounded text-sm focus:border-blue-500 outline-none ${viewMode==='summary'?'bg-gray-100 text-gray-400':''}`} /></div>
                  <div className="col-span-2 flex items-end gap-1">
                      <button onClick={handleSearch} className="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-bold flex items-center justify-center gap-1"><IconSearch /> æŸ¥è¯¢</button>
                      <button onClick={handleReset} className="px-3 py-2 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 text-sm">é‡ç½®</button>
                  </div>
               </div>
               <datalist id="filter_parties">{allParties.map(p => <option key={p} value={p} />)}</datalist>
               <datalist id="filter_specs">{masterData.specs.map(s => <option key={s} value={s} />)}</datalist>
            </div>

            <div className="flex-1 overflow-auto bg-white rounded-lg shadow-sm border border-gray-200">
              {viewMode === 'list' ? (
                  <table className="w-full text-sm text-left">
                    <thead className="bg-gray-50 text-gray-500 font-medium sticky top-0 z-10 border-b border-gray-200">
                      <tr>
                        <th className="px-4 py-3 whitespace-nowrap bg-gray-50">å°è´¦åºå·</th>
                        <th className="px-4 py-3 whitespace-nowrap bg-gray-50">ä¸šåŠ¡æ—¥æœŸ</th>
                        <th className="px-4 py-3 whitespace-nowrap bg-gray-50">ç±»å‹</th>
                        
                        {isLedgerView ? (
                           <>
                             <th className="px-4 py-3 bg-gray-50">å¯¹æ–¹å•ä½ / é¡¹ç›®</th>
                             <th className="px-4 py-3 text-right text-blue-600 bg-blue-50 border-l border-blue-100">æ”¶å…¥ (å¨)</th>
                             <th className="px-4 py-3 text-right text-orange-600 bg-orange-50 border-l border-orange-100">æ”¯å‡º (å¨)</th>
                             <th className="px-4 py-3 text-right bg-gray-100 font-bold border-l border-gray-200">ç»“å­˜ (å¨)</th>
                           </>
                        ) : (
                           <>
                             <th className="px-4 py-3 bg-gray-50">è°ƒå‡ºæ–¹</th>
                             <th className="px-4 py-3 bg-gray-50">è°ƒå…¥æ–¹</th>
                             <th className="px-4 py-3 text-right bg-gray-50">é‡é‡ (å¨)</th>
                           </>
                        )}
                        
                        <th className="px-4 py-3 bg-gray-50">è§„æ ¼</th>
                        <th className="px-4 py-3 bg-gray-50">å¤‡æ³¨</th>
                        <th className="px-4 py-3 w-20 text-center bg-gray-50">æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                      {listWithBalances.length === 0 ? (
                        <tr><td colSpan={isLedgerView ? 10 : 9} className="px-6 py-12 text-center text-gray-400">æ²¡æœ‰æ‰¾åˆ°è®°å½•</td></tr>
                      ) : listWithBalances.map(t => {
                        return (
                        <tr key={t.id} className="hover:bg-gray-50 transition-colors">
                          <td className="px-4 py-3 font-mono text-gray-500 text-xs whitespace-nowrap">{t.serialNo || '-'}</td>
                          <td className="px-4 py-3 font-mono text-gray-600 whitespace-nowrap">{t.date}</td>
                          <td className="px-4 py-3 whitespace-nowrap"><span className="font-medium text-gray-700">{t.displayType}</span></td>
                          
                          {isLedgerView ? (
                              <>
                                <td className="px-4 py-3 text-gray-600 text-xs">{t.opponent}</td>
                                <td className="px-4 py-3 text-right font-mono text-blue-600 bg-blue-50/30 border-l border-blue-50">{t.ledgerCredit ? t.ledgerCredit.toFixed(3) : '-'}</td>
                                <td className="px-4 py-3 text-right font-mono text-orange-600 bg-orange-50/30 border-l border-orange-50">{t.ledgerDebit ? t.ledgerDebit.toFixed(3) : '-'}</td>
                                <td className="px-4 py-3 text-right font-mono font-bold text-gray-700 bg-gray-50/50 border-l border-gray-100">{t.ledgerBalance.toFixed(3)}</td>
                              </>
                          ) : (
                              <>
                                <td className="px-4 py-3 text-gray-600">{t.outParty}</td>
                                <td className="px-4 py-3 text-gray-600">{t.inParty}</td>
                                <td className="px-4 py-3 text-right font-mono font-bold text-gray-700">{Math.abs(t.weight).toFixed(3)}</td>
                              </>
                          )}

                          <td className="px-4 py-3 font-mono text-gray-500 text-xs">{t.spec}</td>
                          <td className="px-4 py-3 text-gray-400 text-xs max-w-xs truncate" title={t.displayNotes}>{t.displayNotes}</td>
                          <td className="px-4 py-3 text-center">
                            <div className="flex items-center justify-center gap-2">
                                <button onClick={() => setEditingItem(t)} className="text-gray-400 hover:text-blue-500 transition-colors p-1" title="ä¿®æ”¹"><IconEdit /></button>
                                <button onClick={() => handleDelete(t)} className="text-gray-400 hover:text-red-500 transition-colors p-1" title="åˆ é™¤"><IconTrash /></button>
                            </div>
                          </td>
                        </tr>
                      )})}
                    </tbody>
                    <tfoot className="bg-gray-50 border-t-2 border-gray-200">
                        <tr>
                            <td colSpan={isLedgerView ? 10 : 9} className="px-4 py-3">
                                <div className="flex justify-end items-center text-sm gap-8">
                                    <span className="text-gray-500">æœ¬é¡µåˆè®¡:</span>
                                    {isLedgerView ? (
                                        <>
                                            <span className="text-blue-600">æ€»æ”¶å…¥: <strong>{ledgerTotals.credit.toFixed(3)}</strong></span>
                                            <span className="text-orange-600">æ€»æ”¯å‡º: <strong>{ledgerTotals.debit.toFixed(3)}</strong></span>
                                            {query.startDate ? (
                                                <span className="ml-4 px-3 py-1 bg-purple-100 text-purple-800 rounded border border-purple-200">
                                                    æœŸé—´å‡€å‘ç”Ÿ: <strong>{(ledgerTotals.credit - ledgerTotals.debit).toFixed(3)}</strong> å¨
                                                </span>
                                            ) : (
                                                <span className="ml-4 px-3 py-1 bg-blue-100 text-blue-800 rounded border border-blue-200">
                                                    è¯¥å¯¹è±¡å½“å‰å®é™…æ€»åº“å­˜: <strong>{currentSubjectTotalStock.toFixed(3)}</strong> å¨
                                                </span>
                                            )}
                                        </>
                                    ) : (
                                        <span className="text-gray-800">æ€»é‡é‡: <strong>{ledgerTotals.vol.toFixed(3)}</strong></span>
                                    )}
                                </div>
                            </td>
                        </tr>
                    </tfoot>
                  </table>
              ) : (
                  <div>
                    <div className="flex items-center gap-4 px-6 py-3 bg-gray-50 border-b border-gray-200 text-sm">
                        <span className="font-bold text-gray-600">æ±‡æ€»æ–¹å¼:</span>
                        <label className="flex items-center cursor-pointer gap-2">
                            <input type="radio" name="groupby" checked={groupBy==='team'} onChange={() => setGroupBy('team')} className="text-blue-600" />
                            <span>æŒ‰ä¸»ä½“æ±‡æ€»</span>
                        </label>
                        <label className="flex items-center cursor-pointer gap-2">
                            <input type="radio" name="groupby" checked={groupBy==='spec'} onChange={() => setGroupBy('spec')} className="text-blue-600" />
                            <span>æŒ‰è§„æ ¼æ±‡æ€»</span>
                        </label>
                    </div>
                    <table className="w-full text-sm text-left">
                        <thead className="bg-gray-50 text-gray-500 font-medium sticky top-0 z-10 border-b border-gray-200">
                        <tr>
                            <th className="px-6 py-3">{groupBy==='team' ? 'ç›¸å…³æ–¹ / é˜Ÿä¼' : 'é’¢ç­‹è§„æ ¼'}</th>
                            <th className="px-6 py-3">{groupBy==='team' ? 'é’¢ç­‹è§„æ ¼' : 'ç›¸å…³æ–¹ / é˜Ÿä¼'}</th>
                            <th className="px-6 py-3 text-right text-gray-500">æœŸåˆæŒæœ‰(å¨)</th>
                            <th className="px-6 py-3 text-right text-green-600">æœŸé—´å…¥åº“/è°ƒå…¥(å¨)</th>
                            <th className="px-6 py-3 text-right text-orange-600">æœŸé—´å‡ºåº“/è°ƒå‡º(å¨)</th>
                            <th className="px-6 py-3 text-right text-blue-700">æœŸæœ«æŒæœ‰(å¨)</th>
                        </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                        {summaryData.length === 0 ? (
                            <tr><td colSpan={6} className="px-6 py-12 text-center text-gray-400">æ²¡æœ‰æ•°æ® (è¯·æ£€æŸ¥ç­›é€‰æ¡ä»¶)</td></tr>
                        ) : summaryData.map((s, idx) => (
                            <tr key={idx} className="hover:bg-gray-50">
                                <td className="px-6 py-3 font-medium text-gray-900">{groupBy==='team' ? s.party : s.spec}</td>
                                <td className="px-6 py-3 font-mono text-gray-600">{groupBy==='team' ? s.spec : s.party}</td>
                                <td className="px-6 py-3 text-right text-gray-500">{s.open.toFixed(3)}</td>
                                <td className="px-6 py-3 text-right text-green-600 font-bold">{s.in > 0 ? `+${s.in.toFixed(3)}` : '-'}</td>
                                <td className="px-6 py-3 text-right text-orange-600 font-bold">{s.out < 0 ? s.out.toFixed(3) : '-'}</td>
                                <td className="px-6 py-3 text-right font-bold text-blue-700 text-base">{s.closing.toFixed(3)}</td>
                            </tr>
                        ))}
                        </tbody>
                        <tfoot className="bg-gray-100 font-bold border-t-2 border-gray-200">
                            <tr>
                                <td className="px-6 py-3 text-gray-800" colSpan={2}>åˆè®¡ (Total)</td>
                                <td className="px-6 py-3 text-right text-gray-600">{summaryTotals.open.toFixed(3)}</td>
                                <td className="px-6 py-3 text-right text-green-700">{summaryTotals.in.toFixed(3)}</td>
                                <td className="px-6 py-3 text-right text-orange-700">{summaryTotals.out.toFixed(3)}</td>
                                <td className="px-6 py-3 text-right text-blue-800 text-lg">{summaryTotals.closing.toFixed(3)}</td>
                            </tr>
                        </tfoot>
                    </table>
                  </div>
              )}
            </div>
            
            {editingItem && (
                <EditModal 
                    transaction={editingItem} 
                    masterData={masterData} 
                    onClose={() => setEditingItem(null)} 
                    onSave={handleSaveEdit} 
                />
            )}
          </div>
        );
      };

      const Settings = ({ masterData, transactions, onSaveMasterData, onLoadBackup, onClearData }) => {
        const [teamsInput, setTeamsInput] = useState('');
        const [sourcesInput, setSourcesInput] = useState('');
        const [specsInput, setSpecsInput] = useState('');
        const [partnersInput, setPartnersInput] = useState('');
        const [recyclersInput, setRecyclersInput] = useState('');
        const fileInputRef = useRef(null);

        useEffect(() => {
          setTeamsInput(masterData.teams ? masterData.teams.join('\n') : '');
          setSourcesInput(masterData.sources ? masterData.sources.join('\n') : '');
          setSpecsInput(masterData.specs ? masterData.specs.join('\n') : '');
          setPartnersInput(masterData.partners ? masterData.partners.join('\n') : '');
          setRecyclersInput(masterData.recyclers ? masterData.recyclers.join('\n') : '');
        }, [masterData]);

        const getCurrentData = () => ({
          teams: teamsInput.split('\n').map(s => s.trim()).filter(Boolean),
          sources: sourcesInput.split('\n').map(s => s.trim()).filter(Boolean),
          specs: specsInput.split('\n').map(s => s.trim()).filter(Boolean),
          partners: partnersInput.split('\n').map(s => s.trim()).filter(Boolean),
          recyclers: recyclersInput.split('\n').map(s => s.trim()).filter(Boolean),
          teamLimits: masterData.teamLimits || {} // Preserve limits on text edit
        });

        const handleSave = () => {
          const newData = getCurrentData();
          
          const removedTeams = masterData.teams.filter(t => !newData.teams.includes(t));
          const removedSources = masterData.sources.filter(s => !newData.sources.includes(s));
          
          for (const t of transactions) {
             if (removedTeams.includes(t.party)) return alert(`æ— æ³•åˆ é™¤é˜Ÿä¼ "${t.party}"ï¼Œå› ä¸ºå­˜åœ¨ç›¸å…³è”çš„å†å²è®°å½•ã€‚\nè¯·æ’¤é”€åˆ é™¤æˆ–ä¿®æ”¹è®°å½•åå†è¯•ã€‚`);
             if (removedSources.includes(t.party)) return alert(`æ— æ³•åˆ é™¤æ¥æº "${t.party}"ï¼Œå› ä¸ºå­˜åœ¨ç›¸å…³è”çš„å†å²è®°å½•ã€‚\nè¯·æ’¤é”€åˆ é™¤æˆ–ä¿®æ”¹è®°å½•åå†è¯•ã€‚`);
          }

          onSaveMasterData(newData);
          alert('è®¾ç½®å·²ä¿å­˜');
        };

        const handleExportBackup = () => {
          const backupData = { transactions: transactions, masterData: getCurrentData(), exportDate: new Date().toISOString(), version: '2.0.0' };
          const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `é’¢ç­‹åº“å­˜ç³»ç»Ÿå¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`;
          link.click();
          return true;
        };
        
        const handleClearDataClick = () => {
            if (transactions.length === 0) return alert("å½“å‰æ²¡æœ‰æµæ°´æ•°æ®ã€‚");
            if (confirm("âš ï¸ å±é™©æ“ä½œè­¦å‘Š âš ï¸\n\nå³å°†ã€æ¸…ç©ºã€‘æ‰€æœ‰å†å²æµæ°´æ•°æ®ï¼\n\nç³»ç»Ÿå°†é¦–å…ˆè‡ªåŠ¨ä¸‹è½½ä¸€ä»½å¤‡ä»½æ–‡ä»¶ã€‚\nè¯·ç¡®ä¿å¤‡ä»½æ–‡ä»¶ä¸‹è½½æˆåŠŸåå†è¿›è¡Œåç»­æ“ä½œã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")) {
                handleExportBackup();
                // Delay to allow backup download to start
                setTimeout(() => {
                    if (confirm("å¤‡ä»½å·²å¯åŠ¨ã€‚\n\næœ€åç¡®è®¤ï¼šæ˜¯å¦æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) {
                        onClearData();
                    }
                }, 1000);
            }
        };

        const handleImportClick = () => fileInputRef.current?.click();
        
        const handleFileChange = (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const json = JSON.parse(event.target?.result);
              if (json.transactions && json.masterData) onLoadBackup(json.transactions, json.masterData);
              else alert('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
            } catch (err) { alert('æ–‡ä»¶è§£æå¤±è´¥'); }
            if (fileInputRef.current) fileInputRef.current.value = '';
          };
          reader.readAsText(file);
        };

        const handleExportStockCSV = () => {
           const stockBySpec = {};
           transactions.forEach(t => {
             if(!stockBySpec[t.spec]) stockBySpec[t.spec] = {in: 0, out: 0};
             if(t.type === 'IN') stockBySpec[t.spec].in += t.weight;
             if(t.type === 'OUT') stockBySpec[t.spec].out += t.weight;
           });
           let csv = "è§„æ ¼å‹å·,ç´¯è®¡å…¥åº“(å¨),ç´¯è®¡å‡ºåº“(å¨),å½“å‰åº“å­˜(å¨)\n";
           Object.entries(stockBySpec).forEach(([spec, data]) => { csv += `${spec},${data.in.toFixed(3)},${data.out.toFixed(3)},${(data.in - data.out).toFixed(3)}\n`; });
          downloadCSV(csv, `åº“å­˜ç›˜ç‚¹æŠ¥è¡¨_${new Date().toISOString().slice(0,10)}.csv`);
        };

        const handleExportMasterDataCSV = () => {
          const currentData = getCurrentData();
          let csv = "ç±»åˆ«,åç§°/å†…å®¹\n";
          currentData.teams.forEach(t => csv += `åŠ³åŠ¡é˜Ÿä¼,${t}\n`);
          currentData.sources.forEach(s => csv += `æ¥æºä¾›åº”å•†,${s}\n`);
          currentData.specs.forEach(s => csv += `é’¢ç­‹è§„æ ¼,${s}\n`);
          currentData.partners.forEach(s => csv += `å¾€æ¥å•ä½,${s}\n`);
          currentData.recyclers.forEach(s => csv += `å›æ”¶å•ä½,${s}\n`);
          downloadCSV(csv, `åŸºç¡€ä¿¡æ¯è®¾ç½®_${new Date().toISOString().slice(0,10)}.csv`);
        };

        const handleExportAllTransactionsCSV = () => {
          const headers = "ä¸šåŠ¡æ—¥æœŸ,ç±»å‹,å­ç±»å‹,ç›¸å…³æ–¹(æ¥æº/é˜Ÿä¼),è§„æ ¼,é‡é‡(å¨),å¤‡æ³¨,ç³»ç»ŸID\n";
          const rows = transactions.map(t => `${t.date},${t.type === 'IN' ? 'å…¥åº“' : 'å‡ºåº“'},${t.subType || '-'},${t.party},${t.spec},${t.weight},"${t.notes.replace(/"/g, '""')}",${t.id}`).join("\n");
          downloadCSV(headers + rows, `å®Œæ•´æµæ°´å°è´¦_${new Date().toISOString().slice(0,10)}.csv`);
        };

        return (
          <div className="p-8 h-full bg-gray-50 overflow-y-auto">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-gray-800">âš™ï¸ åŸºç¡€è®¾ç½®</h2>
              <button onClick={handleSave} className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-all active:scale-95">ä¿å­˜è®¾ç½®</button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-green-100 flex flex-col">
                <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><IconFileExcel /> ğŸ“Š Excel æ•°æ®å¯¼å‡º</h3>
                <div className="space-y-3 flex-1">
                   <button onClick={handleExportStockCSV} className="w-full flex items-center justify-between p-3 border border-green-200 bg-green-50 text-green-800 rounded-lg hover:bg-green-100 transition-colors text-sm"><span>ğŸ“¦ åº“å­˜ç›˜ç‚¹æŠ¥è¡¨</span><span className="text-xs text-green-600 bg-white px-2 py-1 rounded border border-green-100">.csv</span></button>
                  <button onClick={handleExportAllTransactionsCSV} className="w-full flex items-center justify-between p-3 border border-green-200 bg-green-50 text-green-800 rounded-lg hover:bg-green-100 transition-colors text-sm"><span>ğŸ“ å®Œæ•´æµæ°´å°è´¦</span><span className="text-xs text-green-600 bg-white px-2 py-1 rounded border border-green-100">.csv</span></button>
                  <button onClick={handleExportMasterDataCSV} className="w-full flex items-center justify-between p-3 border border-green-200 bg-green-50 text-green-800 rounded-lg hover:bg-green-100 transition-colors text-sm"><span>ğŸ—ï¸ åŸºç¡€ä¿¡æ¯è®¾ç½®</span><span className="text-xs text-green-600 bg-white px-2 py-1 rounded border border-green-100">.csv</span></button>
                </div>
                <p className="text-xs text-gray-400 mt-3">è¯´æ˜: å¯¼å‡ºçš„æ•°æ®å¯ç›´æ¥ä½¿ç”¨ Excel æ‰“å¼€ã€‚</p>
              </div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><IconDownload /> ğŸ’¾ ç³»ç»Ÿæ•°æ®å¤‡ä»½</h3>
                <div className="space-y-3 flex-1">
                  <button onClick={handleExportBackup} className="w-full flex items-center justify-center gap-2 p-3 border border-gray-200 bg-gray-50 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors text-sm"><IconDownload />ä¸‹è½½å®Œæ•´å¤‡ä»½ (.json)</button>
                  <button onClick={handleImportClick} className="w-full flex items-center justify-center gap-2 p-3 border border-orange-200 bg-orange-50 text-orange-700 rounded-lg hover:bg-orange-100 transition-colors text-sm"><IconUpload />æ¢å¤æ•°æ®å¤‡ä»½</button>
                  <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleFileChange} />
                </div>
                <p className="text-xs text-gray-400 mt-3">è¯´æ˜: å¤‡ä»½æ–‡ä»¶ç”¨äºè¿ç§»æ•°æ®åˆ°æ–°è®¾å¤‡ã€‚</p>
              </div>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 className="font-bold text-gray-800 mb-2">ğŸ‘· åŠ³åŠ¡é˜Ÿä¼</h3><p className="text-xs text-gray-400 mb-4">é¢†ç”¨æ–¹åˆ—è¡¨ï¼Œä¸€è¡Œä¸€ä¸ª</p><textarea className="w-full h-64 p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none" value={teamsInput} onChange={e => setTeamsInput(e.target.value)} /></div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 className="font-bold text-gray-800 mb-2">ğŸ­ æ¥æº/ä¾›åº”å•†</h3><p className="text-xs text-gray-400 mb-4">å…¥åº“æ¥æºåˆ—è¡¨ï¼Œä¸€è¡Œä¸€ä¸ª</p><textarea className="w-full h-64 p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none" value={sourcesInput} onChange={e => setSourcesInput(e.target.value)} /></div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 className="font-bold text-gray-800 mb-2">ğŸ“ å¸¸ç”¨è§„æ ¼</h3><p className="text-xs text-gray-400 mb-4">é’¢ç­‹è§„æ ¼å‹å·ï¼Œä¸€è¡Œä¸€ä¸ª</p><textarea className="w-full h-64 p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none" value={specsInput} onChange={e => setSpecsInput(e.target.value)} /></div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 className="font-bold text-gray-800 mb-2">ğŸ¤ å¾€æ¥å•ä½</h3><p className="text-xs text-gray-400 mb-4">è°ƒæ‹¨å‡º/å…¥åº“å•ä½ï¼Œä¸€è¡Œä¸€ä¸ª</p><textarea className="w-full h-64 p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none" value={partnersInput} onChange={e => setPartnersInput(e.target.value)} /></div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 className="font-bold text-gray-800 mb-2">â™»ï¸ å›æ”¶å•ä½</h3><p className="text-xs text-gray-400 mb-4">å¤„ç½®/é”€å”®æ¥æ”¶æ–¹ï¼Œä¸€è¡Œä¸€ä¸ª</p><textarea className="w-full h-64 p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none" value={recyclersInput} onChange={e => setRecyclersInput(e.target.value)} /></div>
            </div>

            <div className="bg-red-50 p-6 rounded-xl border border-red-200 mb-8">
                <h3 className="font-bold text-red-700 mb-4 flex items-center gap-2">ğŸš« å±é™©åŒºåŸŸ</h3>
                <div className="flex flex-col md:flex-row items-center justify-between gap-4">
                    <p className="text-sm text-red-600">æ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰â€œæµæ°´è®°å½•â€æ•°æ®ï¼Œä½†ä¿ç•™åŸºç¡€è®¾ç½®ï¼ˆé˜Ÿä¼/è§„æ ¼ï¼‰ã€‚<br/>ç³»ç»Ÿä¼šåœ¨æ¸…ç©ºå‰å¼ºåˆ¶è‡ªåŠ¨ä¸‹è½½å¤‡ä»½ã€‚</p>
                    <button onClick={handleClearDataClick} className="px-6 py-2 bg-red-600 text-white font-bold rounded-lg shadow hover:bg-red-700 transition-colors">æ¸…ç©ºæ‰€æœ‰æµæ°´æ•°æ®</button>
                </div>
            </div>

          </div>
        );
      };

      const App = () => {
        const [activeTab, setActiveTab] = useState('dashboard');
        const [transactions, setTransactions] = useState(() => {
          const saved = localStorage.getItem('rebar_transactions');
          return saved ? JSON.parse(saved) : [];
        });
        const [masterData, setMasterData] = useState(() => {
          const saved = localStorage.getItem('rebar_master');
          const defaultData = {
            teams: ['ä¸€å·¥åŒº-æœ¨å·¥é˜Ÿ', 'ä¸€å·¥åŒº-é’¢ç­‹ä¸€é˜Ÿ', 'äºŒå·¥åŒº-é’¢ç­‹äºŒé˜Ÿ', 'æ··å‡åœŸç­ç»„'],
            sources: ['å»ºææ€»å…¬å¸', 'é‘«æºé’¢æå‚'],
            specs: ['HRB400E-8', 'HRB400E-10', 'HRB400E-12', 'HRB400E-14', 'HRB400E-16', 'HRB400E-18', 'HRB400E-20', 'HRB400E-22', 'HRB400E-25'],
            partners: ['é¡¹ç›®éƒ¨B', 'äºŒå·¥åŒº'],
            recyclers: ['ç‰©èµ„å›æ”¶ç«™A'],
            teamLimits: {} // Object to store team usage limits { "TeamName": 1000 }
          };
          
          if (!saved) return defaultData;
          
          const parsed = JSON.parse(saved);
          return {
             teams: parsed.teams || defaultData.teams,
             sources: parsed.sources || defaultData.sources,
             specs: parsed.specs || defaultData.specs,
             partners: parsed.partners || defaultData.partners,
             recyclers: parsed.recyclers || defaultData.recyclers,
             teamLimits: parsed.teamLimits || {}
          };
        });

        useEffect(() => { localStorage.setItem('rebar_transactions', JSON.stringify(transactions)); }, [transactions]);
        useEffect(() => { localStorage.setItem('rebar_master', JSON.stringify(masterData)); }, [masterData]);

        const addTransaction = (t) => { setTransactions(prev => [...prev, t]); };
        
        const updateTransaction = (updated) => {
             setTransactions(prev => prev.map(t => t.id === updated.id ? updated : t));
        };

        const deleteTransaction = (id) => { setTransactions(prev => prev.filter(t => t.id !== id)); };
        
        const loadBackup = (t, m) => { if (confirm('è¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦æ¢å¤å—ï¼Ÿ')) { setTransactions(t); setMasterData(m); alert('æ•°æ®æ¢å¤æˆåŠŸï¼'); } };
        
        const clearAllData = () => {
            setTransactions([]);
            alert('æ‰€æœ‰æµæ°´æ•°æ®å·²æ¸…ç©ºã€‚');
        };

        return (
          <div className="flex h-screen w-full bg-gray-100 font-sans text-slate-900">
            <Sidebar activeTab={activeTab} onTabChange={setActiveTab} />
            <main className="flex-1 overflow-hidden relative">
              {activeTab === 'dashboard' && <Dashboard transactions={transactions} masterData={masterData} onUpdateMasterData={setMasterData} />}
              {activeTab === 'entry' && <EntryForm masterData={masterData} transactions={transactions} onAdd={addTransaction} />}
              {activeTab === 'records' && <RecordsTable transactions={transactions} masterData={masterData} onDelete={deleteTransaction} onUpdate={updateTransaction} />}
              {activeTab === 'settings' && <Settings masterData={masterData} transactions={transactions} onSaveMasterData={setMasterData} onLoadBackup={loadBackup} onClearData={clearAllData} />}
            </main>
          </div>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>